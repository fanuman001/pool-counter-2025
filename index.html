<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± ELITE PRO v15</title>
    <style>
        :root { --blue: #0084ff; --red: #ff3333; --green: #00ff88; --gold: #ffd700; --bg: #050505; --card: #1a1c23; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; margin: 0; padding: 10px; overflow-x: hidden; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #333; }
        .p-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; }
        .p-btn { padding: 10px 5px; background: #000; border: 2px solid #333; border-radius: 8px; text-align: center; cursor: pointer; position: relative; }
        .p-btn small { display: block; font-size: 9px; color: #666; }
        .active-t1 { border-color: var(--blue) !important; color: var(--blue); }
        .active-t2 { border-color: var(--red) !important; color: var(--red); }
        .badge { font-size: 9px; padding: 1px 4px; border-radius: 3px; background: #444; color: #fff; margin-top: 2px; display: inline-block; }
        
        .egg-config { display: flex; gap: 4px; margin: 10px 0; overflow-x: auto; padding-bottom: 5px; }
        .egg-config div { flex-shrink: 0; text-align: center; font-size: 11px; }
        
        .history-item { font-size: 12px; border-bottom: 1px solid #333; padding: 8px 0; }
        .history-item b { color: var(--gold); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab { flex: 1; padding: 10px; text-align: center; background: #222; border-radius: 8px; font-size: 14px; }
        .tab.active { background: var(--blue); color: #fff; font-weight: bold; }
        
        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .off-player { opacity: 0.4; }
    </style>
</head>
<body>

<div id="loading">
    <div style="font-size: 40px;">ğŸ±</div>
    <div id="load-msg">æ­£åœ¨å•Ÿå‹•æˆ°å ´åˆ†æç³»çµ±...</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="showTab('game')">æˆ°å ´</div>
    <div class="tab" onclick="showTab('wallet')">éŒ¢åŒ…</div>
    <div class="tab" onclick="showTab('history')">æ­·å²</div>
    <div class="tab" onclick="showTab('analysis')">åˆ†æ</div>
</div>

<div id="tab-game" class="tab-content">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b>ğŸ‘¥ å‡ºæˆ°æˆå“¡</b>
            <div>
                <button onclick="autoTeam()" style="color:var(--blue); background:none; border:none;">ç´”éš¨æ©Ÿåˆ†éšŠ</button>
                <button onclick="allOff()" style="color:var(--red); background:none; border:none; margin-left:10px;">ä¸€éµä¸‹ç·š</button>
            </div>
        </div>
        <div id="p-grid" class="p-grid" style="margin-top:10px;"></div>
    </div>

    <div class="card">
        <b>âš™ï¸ å±€è¨­å®š (åº•/çƒ/å½©)</b>
        <div style="display:flex; gap:10px; margin:10px 0;">
            <input id="v-base" type="number" value="75" style="flex:1">
            <input id="v-ball" type="number" value="25" style="flex:1">
            <input id="v-egg" type="number" value="50" style="flex:1">
        </div>
        <div class="egg-config" id="egg-multi-config">
            </div>
        
        <div id="team-area"></div>
        <button onclick="submitMatch()" style="width:100%; padding:15px; background:var(--green); border:none; font-weight:bold; border-radius:10px; font-size:18px; color:#000; margin-top:10px;">ğŸš€ é€å–®è¨ˆåˆ†</button>
    </div>
</div>

<div id="tab-wallet" class="tab-content" style="display:none;">
    <div class="card">
        <b>ğŸ’ æˆå“¡éŒ¢åŒ… (é¤˜é¡é«˜â†’ä½)</b>
        <div id="w-list"></div>
        <button onclick="settleOrder()" style="width:100%; margin-top:15px; padding:15px; background:var(--gold); border:none; border-radius:10px; color:#000; font-weight:bold;">ğŸ’° ä¸€éµçµå–®ä¸¦æ­¸é›¶</button>
    </div>
</div>

<div id="tab-history" class="tab-content" style="display:none;">
    <div class="card">
        <b>ğŸ“œ æˆ°å±€/è¨‚å–®ç´€éŒ„</b>
        <div id="h-list"></div>
    </div>
</div>

<div id="tab-analysis" class="tab-content" style="display:none;">
    <div class="card">
        <b>ğŸ“Š æˆ°ç•¥èƒ½åŠ›è©•å®š</b>
        <div id="a-list"></div>
    </div>
</div>

<script>
    const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
    const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

    let players = [], matches = [], t1 = [], t2 = [], k1 = 0, k2 = 0, e1 = -1, e2 = -1, winT = 0;
    let eggMulti = [1, 3, 4, 6, 8]; // é è¨­å€æ•¸

    async function init() {
        try {
            const pRes = await fetch(`${API_URL}/players?select=*`, { headers: HEADERS });
            players = await pRes.json();
            const hRes = await fetch(`${API_URL}/history?select=*&order=created_at.desc`, { headers: HEADERS });
            matches = await hRes.json();
            
            renderEggConfig();
            render();
            document.getElementById('loading').style.display = 'none';
        } catch (e) { document.getElementById('load-msg').innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"; }
    }

    function showTab(name) {
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + name).style.display = 'block';
        event.currentTarget.classList.add('active');
        if(name === 'analysis') renderAnalysis();
    }

    function renderEggConfig() {
        const container = document.getElementById('egg-multi-config');
        container.innerHTML = eggMulti.map((m, i) => `
            <div>
                <small>${i+1}é¡†</small><br>
                <input type="number" value="${m}" onchange="eggMulti[${i}]=Number(this.value)" style="width:30px; font-size:10px;">å€
            </div>
        `).join('');
    }

    function render() {
        // çƒå“¡æ¸²æŸ“
        const on = players.filter(p => !p.name.startsWith('OFF_'));
        const off = players.filter(p => p.name.startsWith('OFF_'));
        
        document.getElementById('p-grid').innerHTML = on.map(p => {
            let cls = t1.includes(p.id) ? 'active-t1' : (t2.includes(p.id) ? 'active-t2' : '');
            let stats = getPlayerBrief(p.name);
            return `<div class="p-btn ${cls}" onclick="toggleP(${p.id})">
                <b>${p.name}</b>
                <small>å‹ç‡:${stats.wr}% (${stats.total}å ´)</small>
                <div class="badge">${stats.title}</div>
            </div>`;
        }).join('');

        // éšŠä¼é¡¯ç¤º (æˆ°å±€ä¸­å³æ™‚é¡¯ç¤ºåˆ†æ•¸)
        const curScore = calcPreview();
        const buildTeam = (ids, num, k, eIdx) => `
            <div class="team-box" style="margin-top:10px; border-top: 3px solid ${num===1?'var(--blue)':'var(--red)'}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <button onclick="winT=${num};render()" style="background:${winT===num?(num===1?'var(--blue)':'var(--red)'):'#333'}; border:none; color:#fff; padding:5px 10px; border-radius:4px;">${num===1?'è—éšŠ':'ç´…éšŠ'}${winT===num?'ğŸ†':'å‹?'}</button>
                    <span style="font-size:16px; color:var(--green)">+${curScore[num] || 0}</span>
                </div>
                <div style="margin-top:10px; display:flex; gap:10px; font-size:12px;">
                    çƒ: <b>${k}</b> <button onclick="adjK(${num},1)">+</button><button onclick="adjK(${num},-1)">-</button>
                    å½©è›‹: ${eggMulti.map((v, i) => `<span onclick="setE(${num},${i})" style="padding:2px 5px; border:1px solid #444; border-radius:3px; ${eIdx===i?'background:var(--gold);color:#000':''}">${i+1}</span>`).join(' ')}
                </div>
                <div style="margin-top:5px; font-size:11px; color:#888;">æˆå“¡: ${ids.map(id => players.find(x=>x.id==id).name).join(', ')}</div>
            </div>`;
        document.getElementById('team-area').innerHTML = buildTeam(t1, 1, k1, e1) + buildTeam(t2, 2, k2, e2);

        // éŒ¢åŒ…æ¸²æŸ“
        document.getElementById('w-list').innerHTML = [...players].sort((a,b)=>b.money-a.money).map(p => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #222; ${p.name.startsWith('OFF_')?'opacity:0.3':''}">
                <span onclick="toggleOnline(${p.id},'${p.name}')">${p.name.replace('OFF_','')} ${p.name.startsWith('OFF_')?'(ä¸‹ç·š)':'(ä¸Šç·š)'}</span>
                <b style="color:${p.money>=0?'#0f8':'#f33'}" onclick="manualMoney(${p.id},'${p.name}',${p.money})">${p.money}</b>
            </div>
        `).join('');

        // æ­·å²ç´€éŒ„
        document.getElementById('h-list').innerHTML = matches.map(m => {
            const isOrder = m.description.startsWith('ğŸ’°');
            return `<div class="history-item">
                <div style="display:flex; justify-content:space-between;">
                    <b>${isOrder?'[çµå–®è¨‚å–®]':'[å–®å ´æˆ°å±€]'} ${new Date(m.created_at).toLocaleString()}</b>
                    <button onclick="delHistory(${m.id}, ${isOrder})" style="background:none; border:none; color:var(--red);">âœ• åˆªé™¤</button>
                </div>
                <div>${m.description}</div>
            </div>`;
        }).join('');
    }

    // è¨ˆç®—é è¦½åˆ†æ•¸
    function calcPreview() {
        if(!winT) return {1:0, 2:0};
        const base = Number(document.getElementById('v-base').value);
        const ball = Number(document.getElementById('v-ball').value);
        const eggU = Number(document.getElementById('v-egg').value);
        
        const score1 = base + (k1 - k2) * ball + ((e1 === -1 ? 0 : eggMulti[e1]) - (e2 === -1 ? 0 : eggMulti[e2])) * eggU;
        const score2 = base + (k2 - k1) * ball + ((e2 === -1 ? 0 : eggMulti[e2]) - (e1 === -1 ? 0 : eggMulti[e1])) * eggU;
        
        return winT === 1 ? {1: score1, 2: -Math.floor(score1 * t1.length / t2.length)} : {2: score2, 1: -Math.floor(score2 * t2.length / t1.length)};
    }

    async function submitMatch() {
        const res = calcPreview();
        if(!winT || !t1.length || !t2.length) return alert("è³‡æ–™ä¸å…¨");
        
        let desc = `âš”ï¸ è—(${t1.length}äºº):${res[1]} | ç´…(${t2.length}äºº):${res[2]} | `;
        const updates = [];
        
        for(let id of t1) {
            const p = players.find(x=>x.id==id);
            updates.push(apiUpdate(id, { money: p.money + res[1] }));
            desc += `${p.name},`;
        }
        for(let id of t2) {
            const p = players.find(x=>x.id==id);
            updates.push(apiUpdate(id, { money: p.money + res[2] }));
            desc += `${p.name},`;
        }
        
        await Promise.all(updates);
        await fetch(`${API_URL}/history`, { method: 'POST', headers: HEADERS, body: JSON.stringify({ description: desc }) });
        
        t1=[]; t2=[]; k1=0; k2=0; e1=-1; e2=-1; winT=0;
        await init();
        alert("é€å–®æˆåŠŸ");
    }

    async function delHistory(id, isOrder) {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        const h = matches.find(x=>x.id==id);
        if(!isOrder) { // æœªçµå–®çš„åˆªé™¤ï¼Œè¦å›è£œé‡‘é¡
            const parts = h.description.split('|');
            const scores = parts[0].match(/(-?\d+)/g); // [1]è—åˆ† [2]ç´…åˆ†
            const names = parts[2].split(',');
            for(let name of names) {
                if(!name.trim()) continue;
                const p = players.find(x=>x.name==name.trim());
                if(p) {
                    const isT1 = h.description.includes(`è—(`) && h.description.split('|')[2].indexOf(name) < h.description.indexOf('ç´…('); // ç°¡æ˜“åˆ¤å®š
                    const diff = h.description.includes(name) ? (h.description.indexOf(name) < h.description.indexOf('ç´…(') ? scores[1] : scores[2]) : 0;
                    await apiUpdate(p.id, { money: p.money - Number(diff) });
                }
            }
        }
        await fetch(`${API_URL}/history?id=eq.${id}`, { method: 'DELETE', headers: HEADERS });
        await init();
    }

    async function settleOrder() {
        if(prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼:") !== "8888") return;
        let desc = "ğŸ’° çµå–®æ­¸é›¶ | ";
        for(let p of players) {
            if(p.money !== 0) desc += `${p.name}:${p.money}, `;
            await apiUpdate(p.id, { money: 0 });
        }
        await fetch(`${API_URL}/history`, { method: 'POST', headers: HEADERS, body: JSON.stringify({ description: desc }) });
        await init();
        alert("å·²çµå–®æ­¸é›¶");
    }

    // åˆ†æé‚è¼¯
    function getPlayerBrief(name) {
        const pMatches = matches.filter(m => m.description.includes(name) && m.description.includes('âš”ï¸'));
        const wins = pMatches.filter(m => {
            const scorePart = m.description.split('|');
            const isBlue = scorePart[2].indexOf(name) < scorePart[2].indexOf('ç´…'); 
            return isBlue ? parseInt(scorePart[0].match(/-?\d+/g)[1]) > 0 : parseInt(scorePart[1].match(/-?\d+/g)[0]) > 0;
        });
        const wr = pMatches.length ? Math.round(wins.length / pMatches.length * 100) : 0;
        let title = "æ–°æ‰‹";
        if(pMatches.length > 5) title = "è€æ‰‹";
        if(wr > 60) title = "æˆ°åŠ›ç‹";
        if(wr < 30) title = "æç¬‘ç‹";
        return { wr, total: pMatches.length, title };
    }

    function renderAnalysis() {
        const list = document.getElementById('a-list');
        list.innerHTML = players.map(p => {
            const stats = getPlayerBrief(p.name);
            return `<div style="padding:10px; border-bottom:1px solid #333;">
                <b>${p.name.replace('OFF_','')}</b> - ${stats.title}<br>
                <small>å‹å ´: ${stats.wr}% | ç¸½å ´æ¬¡: ${stats.total}</small>
            </div>`;
        }).join('');
    }

    // è¼”åŠ©åŠŸèƒ½
    function toggleP(id) {
        if(t1.includes(id)) { t1 = t1.filter(x=>x!=id); t2.push(id); }
        else if(t2.includes(id)) { t2 = t2.filter(x=>x!=id); }
        else { t1.push(id); }
        render();
    }
    function adjK(t,v){ if(t==1) k1=Math.max(0,k1+v); else k2=Math.max(0,k2+v); render(); }
    function setE(t,i){ if(t==1) e1=(e1==i?-1:i); else e2=(e2==i?-1:i); render(); }
    function autoTeam() {
        const act = players.filter(p=>!p.name.startsWith('OFF_'));
        t1=[]; t2=[];
        act.sort(()=>Math.random()-0.5).forEach((p,i)=> (i%2==0?t1:t2).push(p.id));
        render();
    }
    async function allOff() {
        if(!confirm("å…¨å“¡ä¸‹ç·šï¼Ÿ")) return;
        for(let p of players) if(!p.name.startsWith('OFF_')) await apiUpdate(p.id, {name:'OFF_'+p.name});
        init();
    }
    async function toggleOnline(id, name) {
        const newName = name.startsWith('OFF_') ? name.replace('OFF_','') : 'OFF_'+name;
        await apiUpdate(id, {name: newName});
        init();
    }
    async function manualMoney(id, name, old) {
        if(prompt("å¯†ç¢¼:")!=='8888') return;
        const v = prompt(`${name} ä¿®æ”¹é¤˜é¡ç‚º:`, old);
        if(v!==null) { await apiUpdate(id, {money: Number(v)}); init(); }
    }
    async function apiUpdate(id, data) {
        return fetch(`${API_URL}/players?id=eq.${id}`, { method: 'PATCH', headers: HEADERS, body: JSON.stringify(data) });
    }

    window.onload = init;
</script>
</body>
</html>
