<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å†°å£ºç›ˆè™§æˆ°å ´ - ELITE v28.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #064e3b;
            background-image: radial-gradient(circle at center, #065f46 0%, #064e3b 100%);
            min-height: 100vh;
            color: white;
            font-family: 'Inter', -apple-system, sans-serif;
        }
        .glass-card {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }
        .team-1-glow { border-left: 6px solid #00d2ff; box-shadow: -10px 0 15px rgba(0, 210, 255, 0.1); }
        .team-2-glow { border-left: 6px solid #ff3e3e; box-shadow: -10px 0 15px rgba(255, 62, 62, 0.1); }
        .team-3-glow { border-left: 6px solid #a855f7; box-shadow: -10px 0 15px rgba(168, 85, 247, 0.1); }
        
        /* è·‘é¦¬ç‡ˆå‹•ç•« */
        .shuffle-active { animation: shuffle-glow 0.15s infinite; }
        @keyframes shuffle-glow {
            0%, 100% { border-color: rgba(255,255,255,0.2); transform: scale(1); }
            50% { border-color: #ffd700; transform: scale(0.95); background: rgba(255,215,0,0.2); }
        }
        
        .tab-active { background: rgba(255,255,255,0.2); color: #ffd700; font-weight: bold; }
        .score-badge { position: absolute; top: -10px; right: -5px; padding: 2px 8px; border-radius: 999px; font-size: 10px; font-weight: 900; }

        /* éš±è—æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4">

<div class="flex gap-2 mb-6 bg-black/40 p-1.5 rounded-2xl">
    <button onclick="showTab('game')" id="tab-game-btn" class="tab-active flex-1 py-3 rounded-xl text-sm transition-all">å³æ™‚æˆ°å ´</button>
    <button onclick="showTab('wallet')" id="tab-wallet-btn" class="flex-1 py-3 rounded-xl text-sm transition-all">éŒ¢åŒ…åå–®</button>
    <button onclick="showTab('history')" id="tab-history-btn" class="flex-1 py-3 rounded-xl text-sm transition-all">æ­·å²/åˆ†æ</button>
</div>

<div id="tab-game" class="space-y-4">
    <div class="glass-card p-4">
        <div class="flex justify-between items-center mb-4">
            <h2 onclick="showTab('wallet')" class="text-emerald-300 font-bold flex items-center gap-1 cursor-pointer underline">
                âš”ï¸ å‡ºæˆ°æˆå“¡ <span class="text-[10px] bg-emerald-800 px-2 py-0.5 rounded text-white">é»æ“Šè·³è½‰ä¸Šç·š</span>
            </h2>
            <button onclick="startShuffle()" class="bg-yellow-500 hover:bg-yellow-400 text-black px-4 py-2 rounded-xl font-black text-sm transition-transform active:scale-90">
                ğŸ° éš¨æ©Ÿåˆ†éšŠ
            </button>
        </div>
        <div id="p-grid" class="grid grid-cols-3 gap-3">
            </div>
    </div>

    <div class="glass-card p-4">
        <div class="flex justify-between items-center cursor-pointer" onclick="toggleId('config-area')">
            <span class="text-gray-300 text-sm font-bold">âš™ï¸ è¦å‰‡è¨­å®š (åº•/æ™®/å½©/å€æ•¸)</span>
            <span class="text-gray-500">â–¼</span>
        </div>
        <div id="config-area" class="hidden mt-4 space-y-4 text-xs border-t border-white/10 pt-4">
            <div class="grid grid-cols-3 gap-4">
                <div>åº•é‡‘: <input id="v-base" type="number" value="75" class="bg-black/50 w-full p-2 rounded mt-1 text-yellow-400" oninput="render()"></div>
                <div>æ™®çƒ: <input id="v-ball" type="number" value="25" class="bg-black/50 w-full p-2 rounded mt-1 text-yellow-400" oninput="render()"></div>
                <div>å½©è›‹: <input id="v-egg" type="number" value="50" class="bg-black/50 w-full p-2 rounded mt-1 text-yellow-400" oninput="render()"></div>
            </div>
            <div class="flex justify-between gap-2">
                <span>å€æ•¸è¨­å®š:</span>
                <div>2é¡†: <input id="m2" type="number" value="3" class="bg-black/50 w-10 p-1 rounded" oninput="render()">x</div>
                <div>3é¡†: <input id="m3" type="number" value="4" class="bg-black/50 w-10 p-1 rounded" oninput="render()">x</div>
                <div>4é¡†: <input id="m4" type="number" value="6" class="bg-black/50 w-10 p-1 rounded" oninput="render()">x</div>
            </div>
        </div>

        <div id="team-area" class="mt-4 space-y-4">
            </div>

        <button onclick="addTeam()" class="w-full py-2 border border-dashed border-gray-500 rounded-xl mt-4 text-gray-400 text-xs">+ æ–°å¢éšŠä¼</button>
        <button onclick="submitMatch()" class="w-full py-5 bg-emerald-500 hover:bg-emerald-400 text-black rounded-2xl mt-4 font-black text-xl shadow-lg shadow-emerald-900/50">ğŸš€ é€å–®çµç®—</button>
    </div>

    <div id="unsettled-log" class="space-y-2"></div>
</div>

<div id="tab-wallet" class="hidden space-y-4">
    <div class="glass-card p-5">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black">ğŸ’ éŒ¢åŒ…/ç‹€æ…‹</h2>
            <button onclick="allOff()" class="text-red-400 text-xs border border-red-400 px-3 py-1 rounded-lg">ä¸€éµä¸‹ç·š</button>
        </div>
        <div id="wallet-online" class="space-y-3"></div>
        <hr class="my-6 border-white/10">
        <h3 class="text-gray-400 text-sm mb-4">ğŸ’¤ æœªä¸Šç·šäººå“¡</h3>
        <div id="wallet-offline" class="grid grid-cols-2 gap-2"></div>
        <button onclick="settleAll()" class="w-full py-4 bg-yellow-500 text-black rounded-2xl mt-8 font-bold">ğŸ’° ä¸€éµçµå–®æ­¸é›¶</button>
    </div>
</div>

<div id="tab-history" class="hidden space-y-6">
    <div id="analysis-area" class="grid grid-cols-1 gap-3"></div>
    <div id="order-list" class="space-y-4"></div>
</div>

<script>
    // é…ç½®èˆ‡åˆå§‹åŒ–
    const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
    const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

    let players = [], matches = [], teamData = [{id:1, k:0, e:0}, {id:2, k:0, e:0}], playerTeams = {}, winTeamId = 0;

    async function init() {
        try {
            const [pRes, hRes] = await Promise.all([
                fetch(`${API_URL}/players?select=*`, { headers: HEADERS }),
                fetch(`${API_URL}/history?select=*&order=created_at.desc`, { headers: HEADERS })
            ]);
            players = await pRes.json();
            matches = await hRes.json();
            render();
        } catch(e) { console.error("åˆå§‹åŒ–å¤±æ•—", e); }
    }

    // --- æ ¸å¿ƒé›¶å’Œè¨ˆç®—é‚è¼¯ ---
    function calc() {
        const base = Number(document.getElementById('v-base').value);
        const ball = Number(document.getElementById('v-ball').value);
        const eggU = Number(document.getElementById('v-egg').value);
        const multis = [0, 1, Number(document.getElementById('m2').value), Number(document.getElementById('m3').value), Number(document.getElementById('m4').value)];
        
        let res = { ind: {}, tTotal: {} };
        if (!winTeamId) return res;

        const allActive = players.filter(p => playerTeams[p.id] > 0);
        const winners = allActive.filter(p => playerTeams[p.id] === winTeamId);
        const losers = allActive.filter(p => playerTeams[p.id] !== winTeamId);

        if (!winners.length || !losers.length) return res;

        // è´å®¶è¨ˆç®— (æ¯äººæ‡‰è´)
        let winPerPerson = base;
        teamData.forEach(t => {
            const side = (t.id === winTeamId) ? 1 : -1;
            winPerPerson += (t.k * ball * side) + (multis[t.e] || 0) * eggU * side;
        });

        const totalPot = winPerPerson * winners.length;
        const lossPerPerson = totalPot / losers.length; // è¼¸å®¶å¹³åˆ†ç¸½é¡

        allActive.forEach(p => {
            if (playerTeams[p.id] === winTeamId) res.ind[p.id] = winPerPerson;
            else res.ind[p.id] = -lossPerPerson;
        });

        teamData.forEach(t => {
            const mems = allActive.filter(p => playerTeams[p.id] === t.id);
            res.tTotal[t.id] = mems.reduce((sum, p) => sum + (res.ind[p.id] || 0), 0);
        });

        return res;
    }

    function render() {
        const scores = calc();
        
        // æ¸²æŸ“ P-Grid
        const pGrid = document.getElementById('p-grid');
        pGrid.innerHTML = players.filter(p => !p.name.startsWith('OFF_')).map(p => {
            const tid = playerTeams[p.id] || 0;
            const sc = scores.ind[p.id] || 0;
            let borderColor = 'border-white/10';
            if(tid==1) borderColor='border-sky-400';
            if(tid==2) borderColor='border-red-400';
            if(tid>=3) borderColor='border-purple-400';

            return `
                <div id="p-btn-${p.id}" onclick="togglePT(${p.id})" class="relative p-3 rounded-2xl border-2 ${borderColor} bg-black/20 text-center transition-all active:scale-95 cursor-pointer">
                    ${sc !== 0 ? `<span class="score-badge ${sc>0?'bg-green-500':'bg-red-500'}">${Math.round(sc)}</span>` : ''}
                    <div class="text-sm font-bold truncate">${p.name}</div>
                    <div class="text-[9px] text-gray-500 uppercase">${getTitle(p.name)}</div>
                </div>
            `;
        }).join('');

        // æ¸²æŸ“ Team-Area
        document.getElementById('team-area').innerHTML = teamData.map(t => {
            const mems = players.filter(p => playerTeams[p.id] === t.id);
            const total = scores.tTotal[t.id] || 0;
            const isWinner = (winTeamId === t.id);
            const ind = mems.length ? Math.abs(Math.round(total / mems.length)) : 0;

            return `
                <div class="glass-card p-4 team-${t.id}-glow ${isWinner ? 'bg-emerald-900/20' : ''}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-xs font-black px-2 py-0.5 rounded bg-black/40 mr-2">TEAM ${t.id}</span>
                            <span class="text-[10px] text-gray-400">${mems.length} äºº</span>
                            <div class="text-[11px] text-gray-300 mt-1">${mems.map(m=>m.name).join(' Â· ')}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold ${total>=0?'text-green-400':'text-red-400'}">éšŠä¼ ${Math.round(total)}</div>
                            <div class="text-[10px] text-gray-500">å€‹äºº (${total>=0?'+':'-'}${ind})</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between gap-4 mt-4">
                        <div class="flex items-center bg-black/40 rounded-xl px-2">
                            <button onclick="adj(${t.id},'k',-1)" class="w-8 h-8 text-xl">-</button>
                            <span class="mx-2 text-sm font-bold text-yellow-400">${t.k} æ™®</span>
                            <button onclick="adj(${t.id},'k',1)" class="w-8 h-8 text-xl">+</button>
                        </div>
                        <div class="flex gap-1">
                            ${[1,2,3,4].map(i => `
                                <button onclick="adj(${t.id},'e',${t.e==i?0:i})" class="w-9 h-9 rounded-full border ${t.e==i?'bg-yellow-500 border-white text-black font-bold':'border-white/20 text-xs'} transition-all">
                                    ${i}åª½
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <button onclick="setW(${t.id})" class="win-gate w-full ${isWinner?'active':''} mt-4">
                        ${isWinner ? 'ğŸ† ç²å‹éšŠä¼' : 'æ¨™è¨˜æ­¤éšŠè´'}
                    </button>
                </div>
            `;
        }).join('');

        // æ¸²æŸ“éŒ¢åŒ…
        const online = players.filter(p => !p.name.startsWith('OFF_')).sort((a,b) => b.money - a.money);
        document.getElementById('wallet-online').innerHTML = online.map(p => `
            <div class="flex justify-between items-center p-4 bg-black/20 rounded-2xl border border-white/5">
                <div>
                    <div class="font-bold flex items-center gap-2">
                        ${p.name} <span class="text-[9px] text-gray-500">WR: ${getWR(p.name)}%</span>
                    </div>
                    <button onclick="toggleOnOff(${p.id},'${p.name}')" class="text-[10px] text-gray-500 hover:text-red-400">ä¸‹ç·šæˆå“¡</button>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-xl font-black ${p.money>=0?'text-green-400':'text-red-400'}">${p.money}</div>
                    <button onclick="manualMoney(${p.id},'${p.name}',${p.money})" class="text-gray-600 text-xs">âœï¸</button>
                </div>
            </div>
        `).join('');

        document.getElementById('wallet-offline').innerHTML = players.filter(p => p.name.startsWith('OFF_')).map(p => `
            <button onclick="toggleOnOff(${p.id},'${p.name}')" class="p-3 bg-white/5 rounded-xl text-xs text-gray-500 hover:bg-white/10">
                + ${p.name.replace('OFF_','')}
            </button>
        `).join('');

        renderHistory();
        renderAnalysis();
    }

    // --- éš¨æ©Ÿåˆ†éšŠ (è·‘é¦¬ç‡ˆ) ---
    function startShuffle() {
        const on = players.filter(p => !p.name.startsWith('OFF_'));
        if (on.length < 2) return;
        let count = 0;
        const interval = setInterval(() => {
            on.forEach(p => {
                const el = document.getElementById(`p-btn-${p.id}`);
                if(el) el.classList.toggle('shuffle-active');
            });
            if (count++ > 15) {
                clearInterval(interval);
                on.forEach(p => {
                    const el = document.getElementById(`p-btn-${p.id}`);
                    if(el) el.classList.remove('shuffle-active');
                });
                playerTeams = {};
                on.sort(() => Math.random() - 0.5).forEach((p, i) => {
                    playerTeams[p.id] = (i % teamData.length) + 1;
                });
                render();
            }
        }, 100);
    }

    // --- æ­·å²èˆ‡åˆ†æ (å…©å±¤æ¶æ§‹) ---
    function renderHistory() {
        const settles = matches.filter(m => m.description.includes('ğŸ’°'));
        document.getElementById('order-list').innerHTML = settles.map(o => {
            const time = new Date(o.created_at).toLocaleString();
            const subMatches = matches.filter(m => !m.description.includes('ğŸ’°') && new Date(m.created_at) < new Date(o.created_at)).slice(0, 10);
            return `
                <div class="glass-card p-4 border border-yellow-500/30">
                    <div class="flex justify-between text-[10px] text-yellow-500 font-bold mb-2">
                        <span>çµå–®å–®è™Ÿ #${o.id}</span>
                        <span>${time}</span>
                    </div>
                    <div class="text-sm font-bold text-green-400 leading-relaxed">${o.description.split('\n')[1] || ""}</div>
                    <div class="mt-4 space-y-1">
                        <div class="text-[9px] text-gray-500 uppercase">æˆ°å ´ç´°é …</div>
                        ${subMatches.map(sm => `
                            <div class="text-[11px] bg-white/5 p-2 rounded border-l-2 border-emerald-500">
                                ${sm.description.split('\n')[0]}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderAnalysis() {
        document.getElementById('analysis-area').innerHTML = players.map(p => {
            const h = matches.filter(m => m.description.includes(p.name));
            if(!h.length) return "";
            return `
                <div class="glass-card p-3 flex justify-between items-center">
                    <div>
                        <span class="font-bold text-white">${p.name.replace('OFF_','')}</span>
                        <span class="text-[9px] ml-2 text-yellow-500 border border-yellow-500 px-1 rounded">${getTitle(p.name)}</span>
                    </div>
                    <div class="text-[10px] text-gray-400 space-x-2">
                        <span>å ´æ¬¡ ${h.length}</span>
                        <span>å‹ç‡ ${getWR(p.name)}%</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    // --- åŠŸèƒ½å‹•ä½œ ---
    async function submitMatch() {
        if (!winTeamId) return alert("è«‹æ¨™è¨˜ç²å‹éšŠä¼");
        const s = calc();
        const winNames = players.filter(p => playerTeams[p.id] === winTeamId).map(p => p.name).join(',');
        let desc = `ğŸ† å† è»:${winNames} | åº•${document.getElementById('v-base').value} æ™®${document.getElementById('v-ball').value}\n`;
        
        for (let p of players) {
            if (playerTeams[p.id]) {
                const amt = Math.round(s.ind[p.id]);
                await patch(p.id, { money: p.money + amt });
                desc += `${p.name}(${amt}) `;
            }
        }
        await fetch(`${API_URL}/history`, { method: 'POST', headers: HEADERS, body: JSON.stringify({ description: desc }) });
        // é‡ç½®å±€å‹¢
        winTeamId = 0; teamData.forEach(t => { t.k = 0; t.e = 0; });
        init();
    }

    async function settleAll() {
        if (prompt("è«‹è¼¸å…¥çµå–®å¯†ç¢¼ 8888") !== '8888') return;
        let summary = `ğŸ’° çµå–®ï¼š\n`;
        players.filter(p => p.money !== 0).sort((a,b)=>b.money-a.money).forEach(p => summary += `${p.name}:${p.money} | `);
        await fetch(`${API_URL}/history`, { method: 'POST', headers: HEADERS, body: JSON.stringify({ description: summary }) });
        for (let p of players) await patch(p.id, { money: 0 });
        init();
    }

    // è¼”åŠ©èˆ‡ç³»çµ±
    function getTitle(n) { const c = matches.filter(m=>m.description.includes(n)).length; return c>30?"è€æ‰‹":c>10?"å¸¸å®¢":"æ–°æ‰‹"; }
    function getWR(n) { const h = matches.filter(m=>m.description.includes(n)); return h.length ? Math.floor(h.filter(m=>m.description.includes('ğŸ†')).length/h.length*100) : 0; }
    function showTab(t) { 
        ['game','wallet','history'].forEach(x => {
            document.getElementById('tab-'+x).classList.toggle('hidden', x!==t);
            document.getElementById('tab-'+x+'-btn').classList.toggle('tab-active', x===t);
        });
    }
    function toggleId(id) { document.getElementById(id).classList.toggle('hidden'); }
    function togglePT(id) { playerTeams[id] = ((playerTeams[id] || 0) + 1) % (teamData.length + 1); render(); }
    function adj(tid, k, v) { const t = teamData.find(x => x.id === tid); if (k === 'k') t.k = Math.max(0, t.k + v); else t.e = v; render(); }
    function setW(id) { winTeamId = (winTeamId === id ? 0 : id); render(); }
    function addTeam() { teamData.push({id: teamData.length+1, k:0, e:0}); render(); }
    async function patch(id, d) { return fetch(`${API_URL}/players?id=eq.${id}`, { method: 'PATCH', headers: HEADERS, body: JSON.stringify(d) }); }
    async function toggleOnOff(id, n) { await patch(id, { name: n.startsWith('OFF_') ? n.replace('OFF_','') : 'OFF_'+n }); init(); }
    async function allOff() { for(let p of players) if(!p.name.startsWith('OFF_')) await patch(p.id, {name:'OFF_'+p.name}); init(); }
    async function manualMoney(id, n, old) { if(prompt("8888")!=='8888') return; const v = prompt(`${n} ä¿®æ”¹ç‚º:`, old); if(v!==null) { await patch(id, {money: parseInt(v)}); init(); } }

    init();
</script>
</body>
</html>
