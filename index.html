<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± ELITE PRO v11</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 15px; }
        .card { background: #151515; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .item { padding: 15px 5px; background: #222; border: 2px solid #444; border-radius: 8px; text-align: center; font-weight: bold; }
        .t1 { border-color: #0084ff; color: #0084ff; }
        .t2 { border-color: #ff3333; color: #ff3333; }
        .win { background: #ffd700 !important; color: #000 !important; border-color: #fff !important; }
        button { cursor: pointer; }
        #loading { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

<div id="loading"><h1>ğŸš€ è¼‰å…¥è³‡æ–™ä¸­...</h1></div>

<div id="main" style="display:none;">
    <div class="card">
        <h3>ğŸ‘¥ é¸æ“‡çƒå“¡ (è—/ç´…/ç„¡)</h3>
        <div id="p-list" class="grid"></div>
    </div>

    <div class="card">
        <h3>ğŸ† èª°è´äº†ï¼Ÿ</h3>
        <div style="display:flex; gap:10px;">
            <button id="btn-t1" onclick="setWin(1)" style="flex:1; padding:15px; background:#0084ff; border:none; border-radius:5px; font-weight:bold; color:white;">è—éšŠè´</button>
            <button id="btn-t2" onclick="setWin(2)" style="flex:1; padding:15px; background:#ff3333; border:none; border-radius:5px; font-weight:bold; color:white;">ç´…éšŠè´</button>
        </div>
        <div style="margin-top:15px;">
            <label>åº•é‡‘: <input id="v-base" type="number" value="75" style="width:50px;"></label>
        </div>
        <button onclick="submit()" style="width:100%; margin-top:15px; padding:18px; background:#00ff88; color:#000; font-weight:bold; border:none; border-radius:8px; font-size:18px;">ğŸš€ é€å‡ºè¨ˆåˆ†</button>
    </div>

    <div class="card">
        <h3>ğŸ’ éŒ¢åŒ…æ’å</h3>
        <div id="w-list"></div>
    </div>
</div>

<script>
    const URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
    const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const _db = supabase.createClient(URL, KEY);

    let players = [], t1 = [], t2 = [], win = 0;

    async function load() {
        const { data, error } = await _db.from('players').select('*');
        if (data) {
            players = data;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main').style.display = 'block';
            render();
        } else {
            document.querySelector('#loading h1').innerText = "âŒ é€£ç·šå¤±æ•—: " + (error ? error.message : "æœªçŸ¥åŸå› ");
        }
    }

    function render() {
        // çƒå“¡é¸å–®
        const active = players.filter(p => !p.name.startsWith('OFF_'));
        document.getElementById('p-list').innerHTML = active.map(p => {
            let cls = t1.includes(p.id) ? 't1' : (t2.includes(p.id) ? 't2' : '');
            return `<div class="item ${cls}" onclick="toggle(${p.id})">${p.name}</div>`;
        }).join('');

        // è´å®¶æŒ‰éˆ•é«˜äº®
        document.getElementById('btn-t1').className = (win === 1 ? 'win' : '');
        document.getElementById('btn-t2').className = (win === 2 ? 'win' : '');

        // éŒ¢åŒ…æ¸…å–®
        document.getElementById('w-list').innerHTML = players.sort((a,b)=>b.money-a.money).map(p => `
            <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333;">
                <span style="${p.name.startsWith('OFF_')?'color:#444':''}">${p.name.replace('OFF_','')}</span>
                <b style="color:${p.money>=0?'#00ff88':'#ff3333'}">${p.money}</b>
            </div>
        `).join('');
    }

    function toggle(id) {
        if (t1.includes(id)) { t1 = t1.filter(x=>x!==id); t2.push(id); }
        else if (t2.includes(id)) { t2 = t2.filter(x=>x!==id); }
        else { t1.push(id); }
        render();
    }

    function setWin(n) { win = n; render(); }

    async function submit() {
        if (!win || !t1.length || !t2.length) return alert("è«‹åˆ†é…éšŠä¼ä¸¦é¸å‡ºè´å®¶");
        const b = Number(document.getElementById('v-base').value);
        const winners = win === 1 ? t1 : t2;
        const losers = win === 1 ? t2 : t1;

        // æ›´æ–°è´å®¶
        for (let id of winners) {
            const p = players.find(x=>x.id===id);
            await _db.from('players').update({ money: p.money + b }).eq('id', id);
        }
        // æ›´æ–°è¼¸å®¶
        const loss = Math.floor((b * winners.length) / losers.length);
        for (let id of losers) {
            const p = players.find(x=>x.id===id);
            await _db.from('players').update({ money: p.money - loss }).eq('id', id);
        }

        alert("è¨ˆåˆ†æˆåŠŸï¼");
        t1 = []; t2 = []; win = 0;
        load();
    }

    window.onload = load;
</script>
</body>
</html>
