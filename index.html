<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± ELITE PRO - æ¥µé™é›»ç«¶ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --blue: #0084ff; --red: #ff3333; --green: #00ff88; --purple: #bf00ff;
            --bg: #0a0b0e; --card: #161a22; --panel: #1f2530; --gold: #ffd700; --text: #e0e6ed; --border: #30363d;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        
        /* æ¨™é¡Œèˆ‡ç‰ˆé¢ */
        h2 { text-align: center; font-size: 2rem; background: linear-gradient(to right, var(--blue), var(--red)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 30px; }
        .main-layout { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1300px; margin: 0 auto; }
        .column { flex: 1; min-width: 350px; }
        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 25px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .section-header { font-size: 1rem; color: #8b949e; font-weight: 900; border-bottom: 2px solid var(--border); padding-bottom: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }

        /* çƒå“¡æŒ‰éˆ•ç¾åŒ– */
        .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        .p-btn { 
            padding: 15px 5px; background: var(--panel); border: 2px solid var(--border); border-radius: 12px; 
            cursor: pointer; text-align: center; font-weight: bold; color: #8b949e; transition: all 0.3s;
            position: relative; overflow: hidden;
        }
        .p-btn.selected { border-width: 2px; color: #fff; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        
        /* éšŠä¼è¨­å®šå€ */
        .team-box { background: #0d1117; padding: 20px; border-radius: 15px; border: 1px solid #30363d; margin-bottom: 15px; border-top: 4px solid #444; transition: 0.3s; }
        .win-btn { 
            width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: 900; cursor: pointer; 
            margin-bottom: 15px; color: #fff; filter: brightness(0.5); font-size: 1rem;
        }
        .win-btn.active { filter: brightness(1.2); box-shadow: 0 0 20px var(--glow-color); border: 2px solid #fff; }
        
        .counter-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; background: #161b22; padding: 10px; border-radius: 10px; }
        .btn-circle { width: 35px; height: 35px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 1.2rem; }
        
        /* å½©è›‹çƒæŒ‰éˆ• */
        .egg-group { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .egg-dot { 
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid #30363d; background: #000; 
            color: #444; cursor: pointer; font-weight: bold; font-size: 0.75rem; 
        }
        .egg-dot.active { border-color: #fff; color: #000; background: var(--gold); box-shadow: 0 0 10px var(--gold); }

        /* åŠŸèƒ½æŒ‰éˆ• */
        .btn-main { width: 100%; padding: 20px; border: none; border-radius: 15px; font-size: 1.3rem; font-weight: 900; cursor: pointer; color: white; transition: 0.3s; margin-top: 10px; }
        .btn-calc { background: linear-gradient(135deg, #238636, #2ea043); }
        .btn-calc:hover { box-shadow: 0 0 25px rgba(46, 160, 67, 0.5); }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .list-row { display: flex; justify-content: space-between; padding: 14px 8px; border-bottom: 1px solid #21262d; align-items: center; }
        .money-val { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .history-card { background: #161b22; padding: 15px; border-radius: 12px; border-left: 5px solid var(--blue); margin-bottom: 12px; position: relative; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* å½ˆçª— */
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card); padding: 30px; border-radius: 25px; width: 90%; max-width: 380px; border: 1px solid var(--border); text-align: center; }
    </style>
</head>
<body>

    <h2>ğŸ± ELITE PRO MANAGEMENT</h2>

    <div class="main-layout">
        <div class="column">
            <div class="card">
                <div class="section-header">
                    <span>ğŸ‘¥ å‡ºæˆ°æˆå“¡ (<span id="count-val">0</span> äºº)</span>
                    <button onclick="quickSplit()" style="background:#30363d; color:white; border:none; padding:5px 12px; border-radius:8px; cursor:pointer; font-size:0.75rem;">âš¡ è‡ªå‹•åˆ†éšŠ</button>
                </div>
                <div id="p-btns" class="player-grid">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="card">
                <div class="section-header">
                    <span>âš™ï¸ å±€è¨­å®š</span>
                    <button onclick="addTeam()" style="background:var(--blue); color:white; border:none; padding:5px 15px; border-radius:8px; cursor:pointer; font-size:0.75rem;">â• æ–°å¢éšŠä¼</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="text-align:center">
                        <small style="color:#8b949e">åº•éŒ¢</small>
                        <input type="number" id="base-p" value="150" style="width:100%; background:transparent; border:none; border-bottom:2px solid var(--border); color:var(--gold); font-size:1.2rem; text-align:center; outline:none;">
                    </div>
                    <div style="text-align:center">
                        <small style="color:#8b949e">æ™®é€šçƒ</small>
                        <input type="number" id="common-p" value="50" style="width:100%; background:transparent; border:none; border-bottom:2px solid var(--border); color:var(--gold); font-size:1.2rem; text-align:center; outline:none;">
                    </div>
                    <div style="text-align:center">
                        <small style="color:#8b949e">å½©è›‹å–®åƒ¹</small>
                        <input type="number" id="egg-p" value="50" style="width:100%; background:transparent; border:none; border-bottom:2px solid var(--border); color:var(--gold); font-size:1.2rem; text-align:center; outline:none;">
                    </div>
                </div>

                <div id="teams-list"></div>
                <button class="btn-main btn-calc" onclick="calculate()">çµç®—ä¸¦å¯«å…¥è³‡æ–™åº«</button>
            </div>
        </div>

        <div class="column">
            <div class="card">
                <div class="section-header">ğŸ’° å‹ç‡èˆ‡éŒ¢åŒ… <button onclick="toggleAdmin()" style="background:none; border:none; cursor:pointer;">âš™ï¸</button></div>
                <div id="admin-panel" style="display:none; background:#000; padding:15px; border-radius:15px; margin-bottom:15px; border:1px solid #333;">
                    <div id="admin-list"></div>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <input id="new-name" style="flex:1; padding:10px; background:#111; border:1px solid #333; color:white; border-radius:8px;" placeholder="æ–°çƒå‹å§“å">
                        <button onclick="addPlayer()" style="padding:10px 20px; background:var(--blue); border:none; border-radius:8px; color:white; font-weight:bold;">æ–°å¢</button>
                    </div>
                </div>
                <div id="board">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="card">
                <div class="section-header">ğŸ“œ æœ€è¿‘ç´€éŒ„</div>
                <div id="log" style="max-height:550px; overflow-y:auto;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h3 id="m-title"></h3>
            <div id="m-detail" style="margin:20px 0; color:#8b949e; line-height:1.8;"></div>
            <button onclick="confirmSubmit()" class="btn-main btn-calc">ç¢ºèªä¸¦å­˜æª”</button>
            <button onclick="closeModal()" style="width:100%; background:none; border:none; color:#555; margin-top:15px; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const PW = "8888";

    let players = [], history = [];
    let teams = [
        { id: 't1', name: 'è—éšŠ', color: '#0084ff', members: [], kills: 0, eggs: 0, eggLimit: 2, win: false },
        { id: 't2', name: 'ç´…éšŠ', color: '#ff3333', members: [], kills: 0, eggs: 0, eggLimit: 2, win: false }
    ];

    async function init() {
        await fetchData();
        _db.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, fetchData).subscribe();
    }

    async function fetchData() {
        const { data: p } = await _db.from('players').select('*').order('id');
        const { data: h } = await _db.from('history').select('*').order('created_at', { ascending: false });
        players = p || []; history = h || [];
        render();
    }

    function addTeam() {
        const colors = ['#00ff88', '#bf00ff', '#ffd700', '#ff8800'];
        const id = 't' + (teams.length + 1);
        teams.push({ id, name: `éšŠä¼${teams.length+1}`, color: colors[teams.length-2] || '#888', members: [], kills: 0, eggs: 0, eggLimit: 2, win: false });
        render();
    }

    function removeTeam(tid) {
        if (teams.length <= 2) return alert("è‡³å°‘éœ€è¦ä¿ç•™å…©å€‹éšŠä¼");
        teams = teams.filter(t => t.id !== tid);
        render();
    }

    function quickSplit() {
        let selected = teams.flatMap(t => t.members);
        if (selected.length < 2) return alert("è«‹å…ˆé¸å–è‡³å°‘å…©ä½çƒå“¡");
        teams.forEach(t => t.members = []); // æ¸…ç©º
        selected.sort(() => Math.random() - 0.5);
        selected.forEach((pid, i) => teams[i % teams.length].members.push(pid));
        render();
    }

    function handlePlayerClick(pid) {
        let currentIdx = teams.findIndex(t => t.members.includes(pid));
        if (currentIdx !== -1) {
            teams[currentIdx].members = teams[currentIdx].members.filter(id => id !== pid);
            if (currentIdx + 1 < teams.length) teams[currentIdx + 1].members.push(pid);
        } else {
            teams[0].members.push(pid);
        }
        render();
    }

    function render() {
        // å‡ºæˆ°äººæ•¸
        const totalP = teams.reduce((s, t) => s + t.members.length, 0);
        document.getElementById('count-val').innerText = totalP;

        // çƒå“¡æŒ‰éˆ•
        const active = players.filter(p => !p.name.startsWith("OFF_"));
        document.getElementById('p-btns').innerHTML = active.map(p => {
            const t = teams.find(team => team.members.includes(p.id));
            const borderStyle = t ? `border-color:${t.color}; box-shadow: 0 0 10px ${t.color}; color:#fff;` : "";
            return `<div class="p-btn ${t?'selected':''}" style="${borderStyle}" onclick="handlePlayerClick(${p.id})">${p.name}</div>`;
        }).join('');

        // éšŠä¼åˆ—è¡¨
        document.getElementById('teams-list').innerHTML = teams.map(t => `
            <div class="team-box" style="border-top-color:${t.color}">
                <button onclick="removeTeam('${t.id}')" style="float:right; background:none; border:none; color:#555; cursor:pointer;">ğŸ—‘ï¸</button>
                <button class="win-btn ${t.win?'active':''}" style="background:${t.color}; --glow-color:${t.color}" onclick="setWinner('${t.id}')">${t.name} ${t.win?'â˜… è´åº•':'çˆ­å¥ªä¸­'}</button>
                <div class="counter-group">
                    <span>çƒæ•¸: <b style="font-size:1.4rem; color:${t.color}">${t.kills}</b></span>
                    <div>
                        <button class="btn-circle" style="background:#30363d" onclick="adjKill('${t.id}',-1)">-</button>
                        <button class="btn-circle" style="background:${t.color}" onclick="adjKill('${t.id}',1)">+</button>
                    </div>
                </div>
                <div class="egg-group">
                    <small style="color:#555">å½©è›‹:</small>
                    ${Array.from({length: t.eggLimit}).map((_,i) => `
                        <div class="egg-dot ${t.eggs>i?'active':''}" onclick="setEgg('${t.id}',${i+1})">${i+1}</div>
                    `).join('')}
                    <button onclick="addEggSlot('${t.id}')" style="background:none; border:1px dashed #444; color:#444; border-radius:50%; width:30px; height:30px; cursor:pointer">+</button>
                </div>
            </div>
        `).join('');

        // éŒ¢åŒ…æ¸…å–®
        document.getElementById('board').innerHTML = players.map(p => {
            const games = history.filter(h => h.blue_members.includes(p.id) || h.red_members.includes(p.id));
            const winCount = history.filter(h => {
                const det = JSON.parse(h.detail_json || '[]');
                const me = det.find(d => d.id === p.id);
                return me && me.change > 0;
            }).length;
            const rate = games.length ? Math.round((winCount/games.length)*100) : 0;
            return `
            <div class="list-row">
                <span style="${p.name.startsWith('OFF_')?'color:#333':''}"><small style="color:#555">${rate}%</small> ${p.name.replace("OFF_","")}</span>
                <span class="money-val" style="color:${p.money>=0?'#00ff88':'#ff3333'}" onclick="manualEdit(${p.id},'${p.name}',${p.money})">${p.money>0?'+':''}${p.money}</span>
            </div>`;
        }).join('');

        // ç´€éŒ„åˆ—è¡¨
        document.getElementById('log').innerHTML = history.slice(0, 15).map(h => `
            <div class="history-card">
                <button onclick="delHistory(${h.id})" style="float:right; background:none; border:1px solid #f33; color:#f33; border-radius:4px; font-size:0.6rem; cursor:pointer;">åˆªé™¤</button>
                <small style="color:#555">${new Date(h.created_at).toLocaleString('zh-TW',{hour12:false})}</small>
                <div style="font-weight:bold; margin-top:5px; font-size:0.9rem;">${h.description}</div>
            </div>
        `).join('');

        // ç®¡ç†å“¡åå–®
        document.getElementById('admin-list').innerHTML = players.map(p => `
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <span>${p.name.replace("OFF_","")}</span>
                <button onclick="toggleRest(${p.id},'${p.name}')">${p.name.startsWith('OFF_')?'ğŸ’¤ ä¼‘æ¯':'âœ… å‡ºæˆ°'}</button>
            </div>
        `).join('');
    }

    function adjKill(tid, v) { const t = teams.find(x=>x.id===tid); t.kills = Math.max(0, t.kills+v); render(); }
    function setEgg(tid, n) { const t = teams.find(x=>x.id===tid); t.eggs = (t.eggs===n) ? n-1 : n; render(); }
    function addEggSlot(tid) { teams.find(x=>x.id===tid).eggLimit++; render(); }
    function setWinner(tid) { teams.forEach(t => t.win = (t.id === tid)); render(); }

    async function calculate() {
        const winner = teams.find(t => t.win);
        if (!winner) return alert("è«‹é¸å‡ºä¸€å€‹ç²å‹éšŠä¼ï¼");
        
        const base = parseInt(document.getElementById('base-p').value);
        const commonP = parseInt(document.getElementById('common-p').value);
        const eggP = parseInt(document.getElementById('egg-p').value);

        let eggMultis = {};
        for(let t of teams) {
            if (t.eggs >= 3) {
                const m = prompt(`ã€${t.name}ã€‘å½©è›‹é” ${t.eggs} é¡†ï¼Œå–®åƒ¹è¦ä¹˜ä»¥å¹¾å€ï¼Ÿ`, t.eggs);
                eggMultis[t.id] = parseInt(m) || 1;
            }
        }

        const getEggScore = (t) => {
            if(t.eggs === 0) return 0;
            if(t.eggs === 1) return eggP;
            if(t.eggs === 2) return eggP * 3;
            return eggP * (eggMultis[t.id] || t.eggs);
        }

        let results = [];
        const playingTeams = teams.filter(t => t.members.length > 0);

        playingTeams.forEach(t => {
            let profit = 0;
            playingTeams.forEach(ot => {
                if(t.id === ot.id) return;
                // åº•éŒ¢
                if(t.win) profit += base;
                else if(ot.win) profit -= base;
                // çƒå·®
                profit += (t.kills - ot.kills) * commonP;
                // å½©è›‹å·®
                profit += (getEggScore(t) - getEggScore(ot));
            });
            const perP = Math.floor(profit / t.members.length);
            t.members.forEach(pid => results.push({ id: pid, change: perP }));
        });

        tempData = { results, desc: `${winner.name}å‹å‡º | ` + playingTeams.map(t=>`${t.name}:${t.kills}çƒ`).join(', ') };
        document.getElementById('m-title').innerText = "çµç®—é è¦½";
        document.getElementById('m-detail').innerHTML = results.map(r => {
            const p = players.find(x=>x.id===r.id);
            return `${p.name.replace("OFF_","")}: <b style="color:${r.change>=0?'#00ff88':'#ff3333'}">${r.change>0?'+':''}${r.change}</b>`;
        }).join('<br>');
        document.getElementById('modal').style.display = 'flex';
    }

    async function confirmSubmit() {
        for(let r of tempData.results) {
            const p = players.find(x=>x.id===r.id);
            await _db.from('players').update({ money: p.money + r.change }).eq('id', p.id);
        }
        await _db.from('history').insert([{
            description: tempData.desc,
            blue_members: teams[0].members, red_members: teams[1].members, // å…¼å®¹èˆŠæ¬„ä½
            detail_json: JSON.stringify(tempData.results)
        }]);
        closeModal();
        teams.forEach(t => { t.kills = 0; t.eggs = 0; t.win = false; });
        fetchData();
    }

    async function delHistory(hid) {
        if(prompt("å¯†ç¢¼:") !== PW) return;
        const h = history.find(x=>x.id===hid);
        const dets = JSON.parse(h.detail_json || '[]');
        for(let d of dets) {
            const p = players.find(x=>x.id===d.id);
            if(p) await _db.from('players').update({ money: p.money - d.change }).eq('id', p.id);
        }
        await _db.from('history').delete().eq('id', hid);
        fetchData();
    }

    async function manualEdit(pid, name, cur) {
        if(prompt("å¯†ç¢¼:") !== PW) return;
        const n = prompt(`ä¿®æ”¹ ${name} çš„é‡‘é¡:`, cur);
        if(n !== null) {
            await _db.from('players').update({ money: parseInt(n) }).eq('id', pid);
            fetchData();
        }
    }

    function toggleAdmin() { const a = document.getElementById('admin-panel'); a.style.display = (a.style.display==='none'?'block':'none'); }
    async function toggleRest(id, name) {
        const nn = name.startsWith("OFF_") ? name.replace("OFF_","") : "OFF_"+name;
        await _db.from('players').update({ name: nn }).eq('id', id);
        fetchData();
    }
    async function addPlayer() {
        const n = document.getElementById('new-name').value;
        if(n) { await _db.from('players').insert([{ name: n, money: 0 }]); document.getElementById('new-name').value = ''; fetchData(); }
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    
    init();
</script>
</body>
</html>
