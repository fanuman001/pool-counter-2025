<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± æ’çƒé›²ç«¯ç®¡ç†ç³»çµ± (é»‘ç™½é›™çƒç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --blue: #0d47a1; --blue-l: #4fc3f7; --red: #bf360c; --red-l: #ff8a65; --bg: #1a1a1a; --card: #252525; --panel: #111; --gold: #ffd700; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); color: #eee; margin: 0; padding: 15px; }
        h2 { text-align: center; color: #aaa; margin-bottom: 20px; letter-spacing: 2px; }
        .main-layout { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .column { flex: 1; min-width: 320px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .section-header { font-size: 0.9rem; color: #888; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        /* å‡ºæˆ°å€ */
        .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        .p-btn { padding: 12px 5px; background: #333; border: 2px solid #444; border-radius: 8px; cursor: pointer; text-align: center; font-weight: bold; }
        .bg-blue { background-color: var(--blue) !important; border-color: var(--blue-l) !important; color: white; transform: scale(1.05); }
        .bg-red { background-color: var(--red) !important; border-color: var(--red-l) !important; color: white; transform: scale(1.05); }
        
        /* é‡‘é¡è¨­å®šå€ (ç§»é™¤å€ç‡ï¼Œæ”¹ç‚ºç‰¹æ®Šçƒå–®åƒ¹) */
        .price-settings { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .price-box { background: var(--panel); padding: 8px; border-radius: 10px; text-align: center; border: 1px solid #444; }
        .price-label { font-size: 0.7rem; color: #777; margin-bottom: 5px; }
        .price-ctrl { display: flex; align-items: center; justify-content: space-between; }
        .price-val { font-size: 1.1rem; font-weight: bold; color: #fb8c00; font-family: monospace; }
        .btn-mini { width: 25px; height: 25px; border-radius: 4px; border: none; background: #444; color: white; cursor: pointer; }

        /* è¨ˆåˆ†å™¨å€ */
        .counter-row { display: flex; justify-content: space-between; align-items: center; background: var(--panel); padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid transparent; }
        .row-blue { border-left-color: var(--blue); }
        .row-red { border-left-color: var(--red); }
        
        /* ç‰¹æ®ŠçƒæŒ‰éˆ• */
        .spec-btn-group { display: flex; gap: 5px; }
        .ball-toggle { width: 45px; height: 35px; border-radius: 6px; border: 1px solid #444; background: #222; color: #666; cursor: pointer; font-size: 0.8rem; font-weight: bold; transition: 0.3s; }
        .ball-white.active { background: #eee !important; color: #000 !important; border-color: #fff !important; box-shadow: 0 0 10px #fff; }
        .ball-black.active { background: #000 !important; color: #fff !important; border-color: #666 !important; box-shadow: 0 0 10px #444; }

        .btn-circle { width: 36px; height: 36px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 1.2rem; }
        .btn-calc { width: 100%; background: linear-gradient(135deg, #6200ea, #3700b3); color: white; padding: 16px; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        .score-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #333; align-items: center; }
        .win-rate { font-size: 0.75rem; color: #666; margin-right: 8px; }
        .money-badge { cursor: pointer; padding: 4px 10px; border-radius: 6px; background: rgba(255,255,255,0.05); font-family: monospace; font-size: 1.1rem; min-width: 65px; text-align: right; }
        .text-plus { color: #69f0ae; } 
        .text-minus { color: #ff5252; font-weight: bold; }
        
        #admin-panel { display: none; background: #111; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #444; }
        .history-list { max-height: 250px; overflow-y: auto; font-size: 0.8rem; }
        .history-item { padding: 10px; border-bottom: 1px solid #333; background: #1a1a1a; margin-bottom: 5px; }

        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:1000; }
        .modal-box { background:var(--card); padding:25px; border-radius:15px; width:85%; max-width:350px; text-align:center; }
    </style>
</head>
<body>

    <h2>ğŸ± æ’çƒé›²ç«¯ç®¡ç†ç³»çµ±</h2>

    <div class="main-layout">
        <div class="column">
            <div class="card">
                <div class="section-header"><span>1. å‡ºæˆ°æˆå“¡</span><span id="player-count">0 äºº</span></div>
                <div id="player-buttons" class="player-grid">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="card">
                <div class="section-header">2. æœ¬å±€è¨­å®š</div>
                <div class="price-settings">
                    <div class="price-box">
                        <div class="price-label">åº•éŒ¢</div>
                        <div class="price-ctrl">
                            <button class="btn-mini" onclick="adjPrice('base', -50)">-</button>
                            <span id="display-base" class="price-val">150</span>
                            <button class="btn-mini" onclick="adjPrice('base', 50)">+</button>
                        </div>
                    </div>
                    <div class="price-box">
                        <div class="price-label">ç‰¹æ®Šçƒ(X)</div>
                        <div class="price-ctrl">
                            <button class="btn-mini" onclick="adjPrice('spec', -10)">-</button>
                            <span id="display-spec" class="price-val">50</span>
                            <button class="btn-mini" onclick="adjPrice('spec', 10)">+</button>
                        </div>
                    </div>
                    <div class="price-box" title="é›™çƒåŒæ™‚é€²æ´çš„çå‹µå€æ•¸">
                        <div class="price-label">é›™çƒçå‹µ</div>
                        <div class="price-ctrl">
                            <button class="btn-mini" onclick="adjPrice('bonus', -1)">-</button>
                            <span id="display-bonus" class="price-val">3</span>
                            <button class="btn-mini" onclick="adjPrice('bonus', 1)">+</button>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <button id="btn-win-a" class="p-btn" style="height:60px" onclick="setWinner('A')">ğŸ”µ è—éšŠ è´åº•</button>
                    <button id="btn-win-b" class="p-btn" style="height:60px" onclick="setWinner('B')">ğŸ”´ ç´…éšŠ è´åº•</button>
                </div>

                <div class="counter-row row-blue">
                    <span>è—éšŠæ™®é€šçƒ</span>
                    <div>
                        <button class="btn-circle" onclick="adjCount('A', -1)" style="background:#444">-</button>
                        <span id="cnt-a" style="margin:0 12px; font-weight:bold; font-size:1.2rem;">0</span>
                        <button class="btn-circle" onclick="adjCount('A', 1)" style="background:var(--blue)">+</button>
                    </div>
                </div>
                <div class="counter-row row-red" style="margin-bottom:15px;">
                    <span>ç´…éšŠæ™®é€šçƒ</span>
                    <div>
                        <button class="btn-circle" onclick="adjCount('B', -1)" style="background:#444">-</button>
                        <span id="cnt-b" style="margin:0 12px; font-weight:bold; font-size:1.2rem;">0</span>
                        <button class="btn-circle" onclick="adjCount('B', 1)" style="background:var(--red)">+</button>
                    </div>
                </div>

                <div class="counter-row row-blue">
                    <span>ğŸ”µ è—éšŠç‰¹æ®Šçƒ</span>
                    <div class="spec-btn-group">
                        <button id="spec-a-w" class="ball-toggle ball-white" onclick="toggleBall('A', 'W')">ç™½çƒ</button>
                        <button id="spec-a-b" class="ball-toggle ball-black" onclick="toggleBall('A', 'B')">é»‘çƒ</button>
                    </div>
                </div>
                <div class="counter-row row-red">
                    <span>ğŸ”´ ç´…éšŠç‰¹æ®Šçƒ</span>
                    <div class="spec-btn-group">
                        <button id="spec-b-w" class="ball-toggle ball-white" onclick="toggleBall('B', 'W')">ç™½çƒ</button>
                        <button id="spec-b-b" class="ball-toggle ball-black" onclick="toggleBall('B', 'B')">é»‘çƒ</button>
                    </div>
                </div>

                <button class="btn-calc" onclick="calculate()">è¨ˆç®—ä¸¦é€å‡º</button>
            </div>
        </div>

        <div class="column">
            <div class="card">
                <div class="section-header">
                    <span>ğŸ’° éŒ¢åŒ… (å‹ç‡ | é¤˜é¡)</span>
                    <button class="btn-edit-tool" onclick="toggleAdmin()">âš™ï¸ ç®¡ç†å“¡</button>
                </div>
                <div id="admin-panel">
                    <div id="admin-list"></div>
                    <input id="new-p-name" style="width:calc(100% - 22px); margin: 10px 0; background:#000; border:1px solid #444; color:white; padding:10px; border-radius:4px;" placeholder="æ–°çƒå‹å§“å">
                    <button onclick="addPlayer()" style="width:100%; padding:10px; background:#2e7d32; color:white; border:none; border-radius:4px; font-weight:bold;">+ æ–°å¢çƒå‹</button>
                    <button onclick="resetAllMoney()" style="width:100%; padding:10px; background:#c62828; color:white; border:none; border-radius:4px; font-weight:bold; margin-top:10px;">âš ï¸ å…¨éƒ¨æ­¸é›¶</button>
                </div>
                <div id="board">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="card">
                <div class="section-header">ğŸ“œ æœ€è¿‘è®Šå‹•ç´€éŒ„</div>
                <div id="history-log" class="history-list"></div>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-box">
            <h3 id="m-title"></h3>
            <div id="m-detail" style="line-height:1.6; color:#ccc; margin-bottom:20px;"></div>
            <div id="modal-footer" style="display: flex; gap: 10px;"></div>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    const ADMIN_PASSWORD = "8888";
    let players = [], history = [], blueIDs = [], redIDs = [], curWinner = null;
    let killsA = 0, killsB = 0;
    let specBalls = { A: { W: false, B: false }, B: { W: false, B: false } };
    let basePrice = 150, commonBallPrice = 50, specBallPrice = 50, bonusMult = 3;

    async function init() {
        await fetchLatest();
        _supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, () => fetchLatest()).subscribe();
    }

    async function fetchLatest() {
        const { data: pData } = await _supabase.from('players').select('*').order('id');
        const { data: hData } = await _supabase.from('history').select('*').order('created_at', { ascending: false });
        players = pData || []; history = hData || [];
        renderUI();
    }

    function getWinRate(playerId) {
        const relevantGames = history.filter(h => h.blue_members && h.red_members);
        const playerGames = relevantGames.filter(h => h.blue_members.includes(playerId) || h.red_members.includes(playerId));
        if (playerGames.length === 0) return "0%";
        const wins = playerGames.filter(h => {
            const isBlue = h.blue_members.includes(playerId);
            const isRed = h.red_members.includes(playerId);
            return (isBlue && h.total_amt > 0) || (isRed && h.total_amt < 0);
        }).length;
        return Math.round((wins / playerGames.length) * 100) + "%";
    }

    function adjPrice(type, val) {
        if(type === 'base') basePrice = Math.max(0, basePrice + val);
        else if(type === 'spec') specBallPrice = Math.max(0, specBallPrice + val);
        else if(type === 'bonus') bonusMult = Math.max(1, bonusMult + val);
        
        document.getElementById('display-base').innerText = basePrice;
        document.getElementById('display-spec').innerText = specBallPrice;
        document.getElementById('display-bonus').innerText = bonusMult;
    }

    function adjCount(t, v) { 
        if(t==='A') killsA = Math.max(0, killsA + v); else killsB = Math.max(0, killsB + v);
        document.getElementById('cnt-a').innerText = killsA; document.getElementById('cnt-b').innerText = killsB;
    }

    function toggleBall(team, color) {
        specBalls[team][color] = !specBalls[team][color];
        const btn = document.getElementById(`spec-${team.toLowerCase()}-${color.toLowerCase()}`);
        if(specBalls[team][color]) btn.classList.add('active'); else btn.classList.remove('active');
    }

    function calculate() {
        if(!blueIDs.length || !redIDs.length || !curWinner) return alert("è«‹é¸äººèˆ‡å‹è² ");
        
        // è¨ˆç®—ç‰¹æ®Šçƒåˆ†æ•¸é‚è¼¯
        function calcSpecScore(team) {
            const hasW = specBalls[team].W;
            const hasB = specBalls[team].B;
            if (hasW && hasB) return specBallPrice * bonusMult; // é›™çƒå¤§ç
            if (hasW || hasB) return specBallPrice; // å–®çƒ
            return 0;
        }

        let specScoreA = calcSpecScore('A');
        let specScoreB = calcSpecScore('B');
        
        // ç¸½é‡‘é¡ = åº•éŒ¢ + (è—æ™®é€šçƒ-ç´…æ™®é€šçƒ)*50 + (è—ç‰¹æ®Š-ç´…ç‰¹æ®Š)
        let commonScore = (killsA - killsB) * commonBallPrice;
        let finalSpecDiff = specScoreA - specScoreB;

        let totalAmt = 0;
        if(curWinner === 'A') totalAmt = basePrice + commonScore + finalSpecDiff;
        else totalAmt = -(basePrice - commonScore - finalSpecDiff);
        
        let calcData = [];
        const absAmt = Math.abs(totalAmt);
        if(totalAmt > 0) {
            blueIDs.forEach(id => calcData.push({id, change: Math.floor(absAmt / blueIDs.length)}));
            redIDs.forEach(id => calcData.push({id, change: -Math.floor(absAmt / redIDs.length)}));
        } else {
            redIDs.forEach(id => calcData.push({id, change: Math.floor(absAmt / redIDs.length)}));
            blueIDs.forEach(id => calcData.push({id, change: -Math.floor(absAmt / blueIDs.length)}));
        }
        
        tempResults = { totalAmt, calcData, desc: totalAmt > 0 ? "ğŸ”µ è—éšŠç²å‹" : "ğŸ”´ ç´…éšŠç²å‹" };
        document.getElementById('m-title').innerText = tempResults.desc;
        document.getElementById('m-detail').innerHTML = `
            çµç®—æ˜ç´°ï¼š<br>
            æ™®é€šçƒå·®é¡ï¼š$${commonScore}<br>
            ç‰¹æ®Šçƒå·®é¡ï¼š$${finalSpecDiff}<br>
            <b>ç¸½è¨ˆé‡‘é¡ï¼š$${absAmt}</b><br><br>
            ` + calcData.map(d => `${players.find(p=>p.id===d.id).name.replace("OFF_","")}: ${d.change>0?'+':''}${d.change}`).join('<br>');
        
        document.getElementById('modal-footer').innerHTML = `<button onclick="confirmUpload()" style="flex:1; padding:12px; background:var(--blue); color:white; border:none; border-radius:8px; font-weight:bold;">ç¢ºèª</button><button onclick="document.getElementById('modal').style.display='none'" style="flex:1; padding:12px; background:#444; color:white; border:none; border-radius:8px;">å–æ¶ˆ</button>`;
        document.getElementById('modal').style.display = 'flex';
    }

    async function confirmUpload() {
        for(let d of tempResults.calcData) {
            const curP = players.find(p => p.id === d.id);
            await _supabase.from('players').update({ money: curP.money + d.change }).eq('id', d.id);
        }
        const specSummary = `A:${specBalls.A.W?'ç™½':''}${specBalls.A.B?'é»‘':''} B:${specBalls.B.W?'ç™½':''}${specBalls.B.B?'é»‘':''}`;
        await _supabase.from('history').insert([{ 
            total_amt: tempResults.totalAmt, 
            description: tempResults.desc + ` (${specSummary})`,
            blue_members: blueIDs, red_members: redIDs
        }]);
        document.getElementById('modal').style.display = 'none';
        resetRound();
    }

    function resetRound() {
        blueIDs = []; redIDs = []; curWinner = null; killsA = 0; killsB = 0;
        specBalls = { A: { W: false, B: false }, B: { W: false, B: false } };
        document.querySelectorAll('.ball-toggle').forEach(b => b.classList.remove('active'));
        document.getElementById('cnt-a').innerText = 0; document.getElementById('cnt-b').innerText = 0;
        setWinner(null); renderUI();
    }

    // --- ä»¥ä¸‹ç‚ºé€šç”¨ç®¡ç†åŠŸèƒ½ ---
    function toggleAdmin() {
        const panel = document.getElementById('admin-panel');
        if (panel.style.display !== 'block') {
            const pw = prompt("ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            if(pw !== ADMIN_PASSWORD) return alert("éŒ¯èª¤");
            panel.style.display = 'block';
        } else { panel.style.display = 'none'; }
    }
    async function toggleStatus(id, name) {
        let newName = name.startsWith("OFF_") ? name.replace("OFF_", "") : "OFF_" + name;
        await _supabase.from('players').update({ name: newName }).eq('id', id);
    }
    async function editMoney(id, name, cur) {
        const pw = prompt("ç®¡ç†å“¡å¯†ç¢¼ï¼š"); if(pw !== ADMIN_PASSWORD) return;
        const v = prompt(`${name} ä¿®æ”¹ç‚ºï¼š`, cur); if(!v) return;
        await _supabase.from('players').update({ money: parseInt(v) }).eq('id', id);
    }
    async function resetAllMoney() {
        if(!confirm("ç¢ºå®šæ­¸é›¶ï¼Ÿ")) return;
        for (let p of players) await _supabase.from('players').update({ money: 0 }).eq('id', p.id);
    }
    async function addPlayer() {
        const n = document.getElementById('new-p-name').value;
        if(n) await _supabase.from('players').insert([{ name: n, money: 0 }]);
    }
    function setWinner(w) { 
        curWinner = w; 
        document.getElementById('btn-win-a').className = w==='A' ? "p-btn bg-blue" : "p-btn";
        document.getElementById('btn-win-b').className = w==='B' ? "p-btn bg-red" : "p-btn";
    }
    function renderUI() {
        const active = players.filter(p => !p.name.startsWith("OFF_"));
        document.getElementById('player-buttons').innerHTML = active.map(p => {
            let cls = "p-btn";
            if(blueIDs.includes(p.id)) cls += " bg-blue";
            if(redIDs.includes(p.id)) cls += " bg-red";
            return `<div class="${cls}" onclick="handlePlayerClick(${p.id})">${p.name}</div>`;
        }).join('');
        document.getElementById('board').innerHTML = players.map(p => `
            <div class="score-row">
                <span>${p.name.replace("OFF_", "")}</span>
                <div><span class="win-rate">${getWinRate(p.id)}</span>
                <span class="money-badge ${p.money>=0?'text-plus':'text-minus'}" onclick="editMoney(${p.id},'${p.name}',${p.money})">${p.money>0?'+':''}${p.money}</span></div>
            </div>
        `).join('');
        document.getElementById('admin-list').innerHTML = players.map(p => `<div style="display:flex; justify:space-between; margin-bottom:5px;"><span>${p.name}</span><button onclick="toggleStatus(${p.id},'${p.name}')">åˆ‡æ›ç‹€æ…‹</button></div>`).join('');
        document.getElementById('history-log').innerHTML = history.slice(0,10).map(h => `<div class="history-item">${h.description} <b style="float:right">${h.total_amt}</b></div>`).join('');
    }
    function handlePlayerClick(id) {
        if(blueIDs.includes(id)) { blueIDs = blueIDs.filter(i => i !== id); redIDs.push(id); }
        else if(redIDs.includes(id)) { redIDs = redIDs.filter(i => i !== id); }
        else { blueIDs.push(id); }
        renderUI();
    }
    init();
</script>
</body>
</html>
