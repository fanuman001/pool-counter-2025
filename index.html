<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± ELITE PRO - æ’çƒç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --blue: #007bff; --blue-glow: rgba(0, 123, 255, 0.6);
            --red: #ff3e3e; --red-glow: rgba(255, 62, 62, 0.6);
            --bg: #050608; --card: #12151a; --panel: #1a1f26;
            --gold: #ffc107; --text: #f0f3f5; --border: #2d343f;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        h2 { text-align: center; color: #fff; text-shadow: 0 0 15px var(--blue-glow); margin-bottom: 25px; font-weight: 900; letter-spacing: 2px; }

        .main-layout { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .column { flex: 1; min-width: 320px; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.8); }
        .section-header { font-size: 0.9rem; color: #6e7a8a; font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 18px; display: flex; justify-content: space-between; align-items: center; }

        /* é‡‘é¡éµç›¤è¼¸å…¥ */
        .price-settings { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        .price-box { background: var(--panel); padding: 10px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .price-label { font-size: 0.65rem; color: #94a3b8; margin-bottom: 5px; }
        .price-input { background: transparent; border: none; color: var(--gold); font-size: 1.2rem; font-weight: bold; width: 100%; text-align: center; outline: none; font-family: monospace; }

        /* å‡ºæˆ°æˆå“¡å€ */
        .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        .p-btn { padding: 14px 5px; background: #1a1f26; border: 1px solid #334155; border-radius: 12px; cursor: pointer; text-align: center; font-weight: bold; color: #94a3b8; transition: 0.2s; }
        .bg-blue { background-color: var(--blue) !important; border-color: #60a5fa !important; color: white !important; box-shadow: 0 0 15px var(--blue-glow); transform: translateY(-2px); }
        .bg-red { background-color: var(--red) !important; border-color: #f87171 !important; color: white !important; box-shadow: 0 0 15px var(--red-glow); transform: translateY(-2px); }
        
        /* å¿«é€Ÿåˆ†éšŠæŒ‰éˆ• */
        .btn-quick { background: #334155; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; }

        /* è¨ˆåˆ†å€ */
        .counter-row { display: flex; justify-content: space-between; align-items: center; background: #0f1216; padding: 12px; border-radius: 15px; margin-bottom: 10px; border: 1px solid var(--border); }
        .btn-circle { width: 38px; height: 38px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 1.2rem; }
        .ball-toggle { width: 48px; height: 38px; border-radius: 8px; border: 1px solid #334155; background: #050608; color: #475569; cursor: pointer; font-weight: bold; }
        .ball-white.active { background: #fff !important; color: #000 !important; box-shadow: 0 0 10px #fff; }
        .ball-black.active { background: #000 !important; color: #fff !important; border-color: #64748b !important; box-shadow: 0 0 10px #444; }

        /* éŒ¢åŒ…èˆ‡ç®¡ç† */
        .score-row { display: flex; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #1e293b; align-items: center; }
        .win-rate { font-size: 0.7rem; color: #64748b; margin-right: 10px; font-family: monospace; }
        .money-val { font-family: monospace; font-weight: bold; cursor: pointer; min-width: 60px; text-align: right; }
        
        .admin-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #0f1216; border-radius: 8px; margin-bottom: 5px; }
        .btn-calc { width: 100%; background: linear-gradient(135deg, #2563eb, #3b82f6); color: white; padding: 18px; border: none; border-radius: 15px; font-size: 1.2rem; font-weight: 900; cursor: pointer; margin-top: 15px; }

        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:999; backdrop-filter: blur(8px); }
        .history-item { padding: 15px; border-radius: 10px; background: #161b22; margin-bottom: 10px; border-left: 4px solid var(--blue); position: relative; font-size: 0.85rem; }
        .btn-delete { color: #f87171; background: none; border: 1px solid #f87171; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; float: right; }
    </style>
</head>
<body>

    <h2>ğŸ± ELITE PRO</h2>

    <div class="main-layout">
        <div class="column">
            <div class="card">
                <div class="section-header">
                    <span>ğŸ‘¥ å‡ºæˆ°æˆå“¡</span>
                    <div>
                        <button class="btn-quick" onclick="quickSplit()">âš¡ éš¨æ©Ÿåˆ†éšŠ</button>
                        <span id="player-count" style="margin-left:10px">0 äºº</span>
                    </div>
                </div>
                <div id="player-buttons" class="player-grid">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="card">
                <div class="section-header">âš™ï¸ å±€è¨­å®š (éµç›¤è¼¸å…¥)</div>
                <div class="price-settings">
                    <div class="price-box"><div class="price-label">åº•éŒ¢</div><input type="number" id="in-base" class="price-input" value="150"></div>
                    <div class="price-box"><div class="price-label">æ™®é€šçƒ</div><input type="number" id="in-common" class="price-input" value="50"></div>
                    <div class="price-box"><div class="price-label">ç‰¹æ®Š(X)</div><input type="number" id="in-spec" class="price-input" value="50"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button id="btn-win-a" class="p-btn" style="height:60px" onclick="setWinner('A')">ğŸ”µ è—éšŠè´åº•</button>
                    <button id="btn-win-b" class="p-btn" style="height:60px" onclick="setWinner('B')">ğŸ”´ ç´…éšŠè´åº•</button>
                </div>

                <div class="counter-row">
                    <span style="color:var(--blue); font-weight:bold;">ğŸ”µ è—å¾—åˆ†</span>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="btn-circle" onclick="adjCount('A', -1)" style="background:#334155">-</button>
                        <span id="cnt-a" style="font-weight:bold; font-size:1.2rem; min-width:20px; text-align:center;">0</span>
                        <button class="btn-circle" onclick="adjCount('A', 1)" style="background:var(--blue)">+</button>
                        <button id="spec-a-w" class="ball-toggle ball-white" onclick="toggleBall('A', 'W')">ç™½</button>
                        <button id="spec-a-b" class="ball-toggle ball-black" onclick="toggleBall('A', 'B')">é»‘</button>
                    </div>
                </div>

                <div class="counter-row">
                    <span style="color:var(--red); font-weight:bold;">ğŸ”´ ç´…å¾—åˆ†</span>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="btn-circle" onclick="adjCount('B', -1)" style="background:#334155">-</button>
                        <span id="cnt-b" style="font-weight:bold; font-size:1.2rem; min-width:20px; text-align:center;">0</span>
                        <button class="btn-circle" onclick="adjCount('B', 1)" style="background:var(--red)">+</button>
                        <button id="spec-b-w" class="ball-toggle ball-white" onclick="toggleBall('B', 'W')">ç™½</button>
                        <button id="spec-b-b" class="ball-toggle ball-black" onclick="toggleBall('B', 'B')">é»‘</button>
                    </div>
                </div>
                <button class="btn-calc" onclick="calculate()">è¨ˆç®—ä¸¦å¯«å…¥è³‡æ–™åº«</button>
            </div>
        </div>

        <div class="column">
            <div class="card">
                <div class="section-header">ğŸ’° å‹ç‡èˆ‡éŒ¢åŒ… <button onclick="toggleAdmin()" style="background:none; border:none; cursor:pointer;">âš™ï¸</button></div>
                <div id="admin-panel" style="display:none; background:#000; padding:15px; border-radius:12px; border:1px solid #334155; margin-bottom:15px;">
                    <div id="admin-list"></div>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <input id="new-p-name" style="flex:1; padding:10px; background:#12151a; border:1px solid #334155; color:white; border-radius:8px;" placeholder="æ–°çƒå‹">
                        <button onclick="addPlayer()" style="padding:10px; background:var(--blue); border:none; color:white; border-radius:8px;">æ–°å¢</button>
                    </div>
                    <button onclick="resetAllMoney()" style="width:100%; padding:10px; background:#450a0a; color:#f87171; border:none; border-radius:8px; margin-top:10px; font-weight:bold;">âš ï¸ å…¨éƒ¨æ­¸é›¶</button>
                </div>
                <div id="board">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="card">
                <div class="section-header">ğŸ“œ æœ€è¿‘ç´€éŒ„</div>
                <div id="history-log" style="max-height:450px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <div id="modal">
        <div style="background:var(--card); padding:25px; border-radius:20px; width:85%; max-width:320px; text-align:center; border:1px solid #334155;">
            <h3 id="m-title" style="margin-top:0;"></h3>
            <div id="m-detail" style="line-height:1.8; margin-bottom:20px; color:#94a3b8;"></div>
            <button onclick="confirmUpload()" style="width:100%; padding:15px; background:var(--blue); color:white; border:none; border-radius:12px; font-weight:bold;">ç¢ºå®š</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; background:none; border:none; color:#64748b; margin-top:10px;">å–æ¶ˆ</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const ADMIN_PW = "8888";

    let players = [], history = [], blueIDs = [], redIDs = [], curWinner = null;
    let killsA = 0, killsB = 0, specBalls = { A: { W: false, B: false }, B: { W: false, B: false } };

    async function init() {
        await fetchLatest();
        _supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, () => fetchLatest()).subscribe();
    }

    async function fetchLatest() {
        const { data: pData } = await _supabase.from('players').select('*').order('id');
        const { data: hData } = await _supabase.from('history').select('*').order('created_at', { ascending: false });
        players = pData || []; history = hData || [];
        renderUI();
    }

    // è¨ˆç®—å‹ç‡
    function getWinRate(pid) {
        const games = history.filter(h => h.blue_members.includes(pid) || h.red_members.includes(pid));
        if (games.length === 0) return "0%";
        const wins = games.filter(h => {
            const isBlue = h.blue_members.includes(pid);
            return (isBlue && h.total_amt > 0) || (!isBlue && h.total_amt < 0);
        }).length;
        return Math.round((wins / games.length) * 100) + "%";
    }

    // å¿«é€Ÿåˆ†éšŠ
    function quickSplit() {
        let selected = [...blueIDs, ...redIDs];
        if (selected.length < 2) return alert("è«‹å…ˆæ‰‹å‹•é¸æ“‡è‡³å°‘å…©åçƒå“¡");
        selected.sort(() => Math.random() - 0.5);
        const mid = Math.ceil(selected.length / 2);
        blueIDs = selected.slice(0, mid);
        redIDs = selected.slice(mid);
        renderUI();
    }

    // æ‰‹å‹•ä¿®æ”¹é‡‘é¡ (ç®¡ç†å“¡)
    async function editMoney(pid, name, cur) {
        if(prompt("ç®¡ç†å“¡å¯†ç¢¼ï¼š") !== ADMIN_PW) return;
        const newVal = prompt(`ä¿®æ”¹ ${name} çš„é‡‘é¡ï¼š`, cur);
        if (newVal !== null) {
            await _supabase.from('players').update({ money: parseInt(newVal) }).eq('id', pid);
        }
    }

    function toggleBall(team, color) {
        specBalls[team][color] = !specBalls[team][color];
        document.getElementById(`spec-${team.toLowerCase()}-${color.toLowerCase()}`).classList.toggle('active');
    }

    function adjCount(t, v) { 
        if(t==='A') killsA = Math.max(0, killsA + v); else killsB = Math.max(0, killsB + v);
        document.getElementById('cnt-a').innerText = killsA; document.getElementById('cnt-b').innerText = killsB;
    }

    function calculate() {
        if(!blueIDs.length || !redIDs.length || !curWinner) return alert("âŒ è«‹é¸äººèˆ‡å‹è² ");
        const base = parseInt(document.getElementById('in-base').value) || 0;
        const commonP = parseInt(document.getElementById('in-common').value) || 0;
        const specP = parseInt(document.getElementById('in-spec').value) || 0;

        const getSpecScore = (team) => {
            const count = (specBalls[team].W ? 1 : 0) + (specBalls[team].B ? 1 : 0);
            return count === 2 ? specP * 3 : (count === 1 ? specP : 0);
        };

        let commonDiff = (killsA - killsB) * commonP; 
        let specDiff = getSpecScore('A') - getSpecScore('B');
        let total = curWinner === 'A' ? (base + commonDiff + specDiff) : -(base - commonDiff - specDiff);
        const absTotal = Math.abs(total);

        let calcData = [];
        const splitAmt = (amt, list) => list.forEach(id => calcData.push({id, change: Math.floor(amt / list.length)}));
        if(total > 0) { splitAmt(absTotal, blueIDs); splitAmt(-absTotal, redIDs); } 
        else { splitAmt(absTotal, redIDs); splitAmt(-absTotal, blueIDs); }

        tempResults = { total, calcData, desc: `${total > 0 ? 'ğŸ”µè—å‹':'ğŸ”´ç´…å‹'} $${absTotal}` };
        document.getElementById('m-title').innerText = tempResults.desc;
        document.getElementById('m-detail').innerHTML = calcData.map(d => `${players.find(x=>x.id===d.id).name.replace("OFF_","")}: ${d.change>0?'+':''}${d.change}`).join('<br>');
        document.getElementById('modal').style.display = 'flex';
    }

    async function confirmUpload() {
        for(let d of tempResults.calcData) {
            const p = players.find(x => x.id === d.id);
            await _supabase.from('players').update({ money: p.money + d.change }).eq('id', d.id);
        }
        await _supabase.from('history').insert([{ 
            total_amt: tempResults.total, description: tempResults.desc,
            blue_members: blueIDs, red_members: redIDs, detail_json: JSON.stringify(tempResults.calcData)
        }]);
        document.getElementById('modal').style.display = 'none';
        resetRound();
    }

    async function deleteOrder(hid) {
        if(prompt("å¯†ç¢¼ï¼š") !== ADMIN_PW) return;
        const order = history.find(h => h.id === hid);
        const details = JSON.parse(order.detail_json);
        for(let d of details) {
            const p = players.find(x => x.id === d.id);
            if(p) await _supabase.from('players').update({ money: p.money - d.change }).eq('id', p.id);
        }
        await _supabase.from('history').delete().eq('id', hid);
    }

    async function toggleStatus(id, name) {
        const newName = name.startsWith("OFF_") ? name.replace("OFF_", "") : "OFF_" + name;
        await _supabase.from('players').update({ name: newName }).eq('id', id);
    }

    function renderUI() {
        const active = players.filter(p => !p.name.startsWith("OFF_"));
        document.getElementById('player-buttons').innerHTML = active.map(p => `
            <div class="p-btn ${blueIDs.includes(p.id)?'bg-blue':(redIDs.includes(p.id)?'bg-red':'')}" onclick="handlePlayerClick(${p.id})">${p.name}</div>
        `).join('');
        document.getElementById('player-count').innerText = `${blueIDs.length + redIDs.length} äºº`;

        document.getElementById('board').innerHTML = players.map(p => `
            <div class="score-row">
                <span style="${p.name.startsWith('OFF_')?'color:#475569':''}"><span class="win-rate">${getWinRate(p.id)}</span>${p.name.replace("OFF_","")}</span>
                <span class="money-val" style="color:${p.money>=0?'#4ade80':'#f87171'}" onclick="editMoney(${p.id},'${p.name}',${p.money})">${p.money>0?'+':''}${p.money}</span>
            </div>
        `).join('');

        document.getElementById('admin-list').innerHTML = players.map(p => `
            <div class="admin-row">
                <span>${p.name.replace("OFF_","")}</span>
                <button onclick="toggleStatus(${p.id}, '${p.name}')" style="background:#334155; border:none; color:white; border-radius:5px; padding:5px 10px;">${p.name.startsWith('OFF_')?'ğŸ’¤ ä¼‘æ¯':'âœ… å‡ºæˆ°'}</button>
            </div>
        `).join('');

        document.getElementById('history-log').innerHTML = history.slice(0, 15).map(h => `
            <div class="history-item">
                <button class="btn-delete" onclick="deleteOrder(${h.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                <small style="color:#64748b">${new Date(h.created_at).toLocaleTimeString()}</small><br>${h.description}
            </div>
        `).join('');
    }

    function handlePlayerClick(id) {
        if(blueIDs.includes(id)) { blueIDs = blueIDs.filter(i => i !== id); redIDs.push(id); }
        else if(redIDs.includes(id)) { redIDs = redIDs.filter(i => i !== id); }
        else { blueIDs.push(id); }
        renderUI();
    }

    function setWinner(w) { 
        curWinner = w; 
        document.getElementById('btn-win-a').className = w==='A' ? "p-btn bg-blue" : "p-btn";
        document.getElementById('btn-win-b').className = w==='B' ? "p-btn bg-red" : "p-btn";
    }

    function toggleAdmin() {
        const p = document.getElementById('admin-panel');
        if(p.style.display === 'none') {
            if(prompt("å¯†ç¢¼ï¼š") === ADMIN_PW) p.style.display = 'block';
        } else p.style.display = 'none';
    }

    async function addPlayer() {
        const n = document.getElementById('new-p-name').value;
        if(n) { await _supabase.from('players').insert([{ name: n, money: 0 }]); document.getElementById('new-p-name').value = ''; }
    }

    async function resetAllMoney() {
        if(confirm("ç¢ºå®šå…¨éƒ¨æ­¸é›¶ï¼Ÿ") && prompt("å¯†ç¢¼") === ADMIN_PW) {
            for(let p of players) await _supabase.from('players').update({ money: 0 }).eq('id', p.id);
            await _supabase.from('history').delete().neq('id', 0);
        }
    }

    function resetRound() {
        blueIDs = []; redIDs = []; curWinner = null; killsA = 0; killsB = 0;
        specBalls = { A: { W: false, B: false }, B: { W: false, B: false } };
        document.querySelectorAll('.ball-toggle').forEach(b => b.classList.remove('active'));
        document.getElementById('cnt-a').innerText = 0; document.getElementById('cnt-b').innerText = 0;
        setWinner(null); renderUI();
    }

    init();
</script>
</body>
</html>
