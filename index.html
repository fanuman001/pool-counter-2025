<script>
/* ===============================
   åŸºæœ¬è¨­å®š
=============================== */
const SUPABASE_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
const SUPABASE_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_PW = "8888";

/* ===============================
   ç‹€æ…‹
=============================== */
let players = [];
let history = [];
let tempSubmit = null;

/* ===============================
   åˆ†éšŠ
=============================== */
let teams = [
  { id:'t1', name:'è—éšŠ', color:'#0084ff', members:[], kills:0, eggs:[], win:false },
  { id:'t2', name:'ç´…éšŠ', color:'#ff3333', members:[], kills:0, eggs:[], win:false }
];

/* ===============================
   åˆå§‹åŒ–
=============================== */
init();
async function init() {
  await fetchData();
}

/* ===============================
   è³‡æ–™è¼‰å…¥
=============================== */
async function fetchData() {
  const { data:p } = await _db.from('players').select('*').order('id');
  const { data:h } = await _db.from('history').select('*').order('created_at', {ascending:false});
  players = p || [];
  history = h || [];
  render();
}

/* ===============================
   UI æ¸²æŸ“ï¼ˆæœ€å°å¿…è¦ï¼‰
=============================== */
function render() {
  document.getElementById('teams-list').innerHTML = teams.map(t=>{
    const names = t.members.map(id=>players.find(p=>p.id===id)?.name.replace("OFF_","")).join('ã€');
    return `<div style="border-left:5px solid ${t.color};padding:8px;margin-bottom:8px">
      <b>${t.name}</b><br><small>${names||'å°šæœªåˆ†éšŠ'}</small>
      <div>æ“Šçƒ ${t.kills}</div>
      <button onclick="adjKills('${t.id}',1)">+</button>
      <button onclick="adjKills('${t.id}',-1)">-</button>
      <button onclick="setWinner('${t.id}')">${t.win?'ğŸ†':'å‹åˆ©'}</button>
    </div>`;
  }).join('');
}

/* ===============================
   æ“ä½œ
=============================== */
function adjKills(id,val){
  const t=teams.find(x=>x.id===id);
  t.kills=Math.max(0,t.kills+val);
  render();
}
function setWinner(id){
  teams.forEach(t=>t.win=false);
  teams.find(t=>t.id===id).win=true;
  render();
}

/* ===============================
   çµç®—
=============================== */
async function calculate(){
  const winners=teams.filter(t=>t.win);
  if(!winners.length) return alert("è«‹æ¨™è¨˜å‹éšŠ");

  let results=[];
  teams.forEach(t=>{
    const base=t.win?150:-150;
    const per=Math.floor(base/t.members.length);
    t.members.forEach(pid=>{
      results.push({player_id:pid,profit:per});
    });
  });

  tempSubmit={results};
  await confirmSubmit();
}

/* ===============================
   ç¢ºèªé€å‡º + è‡ªå‹•åˆ†æ
=============================== */
async function confirmSubmit(){
  /* 1ï¸âƒ£ æ›´æ–°é‡‘é¡ */
  for(const r of tempSubmit.results){
    const p=players.find(x=>x.id===r.player_id);
    await _db.from('players')
      .update({money:p.money+r.profit})
      .eq('id',p.id);
  }

  /* 2ï¸âƒ£ å¯«å…¥åˆ†æ */
  await runAutoAnalysis(tempSubmit.results);

  /* 3ï¸âƒ£ æ­·å²ï¼ˆå¯åˆªï¼‰ */
  await _db.from('history').insert([{
    description:'âš”ï¸ å°å±€å®Œæˆ'
  }]);

  resetTeams();
  fetchData();
}

/* ===============================
   ğŸ”¥ è‡ªå‹•åˆ†ææ ¸å¿ƒ
=============================== */
async function runAutoAnalysis(results){
  const teamMap={};
  teams.forEach(t=>t.members.forEach(p=>teamMap[p]=t));

  /* å€‹äººåˆ†æ */
  for(const r of results){
    const pid=r.player_id;
    const profit=r.profit;

    const { data:old } = await _db
      .from('player_analysis')
      .select('*')
      .eq('player_id',pid)
      .single();

    if(!old){
      await _db.from('player_analysis').insert([{
        player_id:pid,
        games_played:1,
        presence_score:profit,
        avg_profit:profit,
        volatility:0
      }]);
    }else{
      const gp=old.games_played+1;
      const avg=(old.avg_profit*old.games_played+profit)/gp;
      const vol=Math.abs(profit-avg);
      await _db.from('player_analysis').update({
        games_played:gp,
        avg_profit:avg,
        presence_score:avg,
        volatility:(old.volatility+vol)/2,
        updated_at:new Date()
      }).eq('player_id',pid);
    }
  }

  /* é›™äººåˆ†æ */
  for(const t of teams){
    for(let i=0;i<t.members.length;i++){
      for(let j=i+1;j<t.members.length;j++){
        const a=t.members[i];
        const b=t.members[j];
        const pair=[Math.min(a,b),Math.max(a,b)];

        const teamProfit=results
          .filter(r=>pair.includes(r.player_id))
          .reduce((s,r)=>s+r.profit,0);

        const { data:old } = await _db
          .from('pair_analysis')
          .select('*')
          .eq('player_a',pair[0])
          .eq('player_b',pair[1])
          .single();

        if(!old){
          await _db.from('pair_analysis').insert([{
            player_a:pair[0],
            player_b:pair[1],
            games_together:1,
            synergy_score:teamProfit
          }]);
        }else{
          const g=old.games_together+1;
          const syn=(old.synergy_score*old.games_together+teamProfit)/g;
          await _db.from('pair_analysis').update({
            games_together:g,
            synergy_score:syn,
            updated_at:new Date()
          }).eq('player_a',pair[0]).eq('player_b',pair[1]);
        }
      }
    }
  }
}

/* ===============================
   é‡ç½®
=============================== */
function resetTeams(){
  teams.forEach(t=>{
    t.kills=0;
    t.eggs=[];
    t.win=false;
  });
}
</script>
