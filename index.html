<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± ELITE PRO - å¤šéšŠä¼å½©è›‹ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --blue: #007bff; --red: #ff3e3e; --green: #2ecc71; --purple: #9b59b6;
            --bg: #050608; --card: #12151a; --panel: #1a1f26;
            --gold: #ffc107; --text: #f0f3f5; --border: #2d343f;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        h2 { text-align: center; color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.2); margin-bottom: 25px; font-weight: 900; letter-spacing: 2px; }

        .main-layout { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .column { flex: 1; min-width: 320px; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .section-header { font-size: 0.9rem; color: #6e7a8a; font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 18px; display: flex; justify-content: space-between; align-items: center; }

        /* å±€è¨­å®š */
        .price-settings { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .price-box { background: var(--panel); padding: 10px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .price-input { background: transparent; border: none; color: var(--gold); font-size: 1.2rem; font-weight: bold; width: 100%; text-align: center; outline: none; }

        /* çƒå“¡èˆ‡éšŠä¼ */
        .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-bottom: 10px; }
        .p-btn { padding: 12px 5px; background: #1a1f26; border: 1px solid #334155; border-radius: 10px; cursor: pointer; text-align: center; font-weight: bold; color: #94a3b8; }
        
        .team-container { background: #0f1216; padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid #444; }
        .team-win-btn { padding: 10px; width: 100%; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; color: white; opacity: 0.6; }
        .team-win-btn.active { opacity: 1; box-shadow: 0 0 15px rgba(255,255,255,0.3); transform: scale(1.02); }

        .egg-grid { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .egg-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #334155; background: #000; color: #444; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .egg-btn.active { background: var(--gold) !important; color: #000 !important; border-color: #fff !important; box-shadow: 0 0 10px var(--gold); }

        /* åˆ—è¡¨ */
        .score-row { display: flex; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #1e293b; }
        .history-item { padding: 15px; border-radius: 10px; background: #161b22; margin-bottom: 10px; border-left: 4px solid var(--gold); position: relative; }
        .btn-delete { color: #f87171; background: none; border: 1px solid #f87171; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; float: right; }
        
        .btn-calc { width: 100%; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 18px; border: none; border-radius: 15px; font-size: 1.2rem; font-weight: 900; cursor: pointer; }
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:999; backdrop-filter: blur(8px); }
    </style>
</head>
<body>

    <h2>ğŸ± ELITE MULTI-TEAM</h2>

    <div class="main-layout">
        <div class="column">
            <div class="card">
                <div class="section-header"><span>ğŸ‘¥ å‡ºæˆ°æˆå“¡</span><span id="player-count">0 äºº</span></div>
                <div id="player-buttons" class="player-grid">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="card">
                <div class="section-header">
                    <span>âš™ï¸ å±€è¨­å®š</span>
                    <button onclick="addTeam()" style="background:var(--green); border:none; color:white; padding:4px 10px; border-radius:5px; font-size:0.75rem; cursor:pointer;">â• æ–°å¢éšŠä¼</button>
                </div>
                <div class="price-settings">
                    <div class="price-box"><div style="font-size:0.6rem">åº•éŒ¢</div><input type="number" id="in-base" class="price-input" value="150"></div>
                    <div class="price-box"><div style="font-size:0.6rem">æ™®é€šçƒ</div><input type="number" id="in-common" class="price-input" value="50"></div>
                    <div class="price-box"><div style="font-size:0.6rem">å½©è›‹å–®åƒ¹</div><input type="number" id="in-egg" class="price-input" value="50"></div>
                </div>

                <div id="teams-area"></div>
                <button class="btn-calc" onclick="calculate()">çµç®—ä¸¦é€å‡º</button>
            </div>
        </div>

        <div class="column">
            <div class="card">
                <div class="section-header">ğŸ’° å‹ç‡èˆ‡éŒ¢åŒ… <button onclick="toggleAdmin()" style="background:none; border:none; cursor:pointer;">âš™ï¸</button></div>
                <div id="admin-panel" style="display:none; background:#000; padding:15px; border-radius:12px; margin-bottom:15px;">
                    <div id="admin-list"></div>
                    <button onclick="resetAllMoney()" style="width:100%; padding:10px; background:#450a0a; color:#f87171; border:none; border-radius:8px; margin-top:10px;">âš ï¸ å…¨éƒ¨æ­¸é›¶</button>
                </div>
                <div id="board">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="card">
                <div class="section-header">ğŸ“œ æœ€è¿‘ç´€éŒ„</div>
                <div id="history-log" style="max-height:450px; overflow-y:auto;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <div id="modal">
        <div style="background:var(--card); padding:25px; border-radius:20px; width:85%; max-width:320px; text-align:center;">
            <h3 id="m-title"></h3>
            <div id="m-detail" style="line-height:1.8; margin-bottom:20px; color:#94a3b8;"></div>
            <button onclick="confirmUpload()" style="width:100%; padding:15px; background:var(--gold); color:black; border:none; border-radius:12px; font-weight:bold;">ç¢ºèªå¯«å…¥</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; background:none; border:none; color:#64748b; margin-top:10px;">å–æ¶ˆ</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const ADMIN_PW = "8888";

    let players = [], history = [], teams = [
        { id: 1, name: 'è—éšŠ', color: '#007bff', members: [], kills: 0, eggs: 0, eggMax: 2, win: false },
        { id: 2, name: 'ç´…éšŠ', color: '#ff3e3e', members: [], kills: 0, eggs: 0, eggMax: 2, win: false }
    ];

    async function init() {
        await fetchLatest();
        _supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, () => fetchLatest()).subscribe();
    }

    async function fetchLatest() {
        const { data: pData } = await _supabase.from('players').select('*').order('id');
        const { data: hData } = await _supabase.from('history').select('*').order('created_at', { ascending: false });
        players = pData || []; history = hData || [];
        renderUI();
    }

    function addTeam() {
        const colors = ['#2ecc71', '#9b59b6', '#f1c40f', '#e67e22'];
        const newId = teams.length + 1;
        teams.push({ id: newId, name: `éšŠä¼${newId}`, color: colors[newId-3] || '#888', members: [], kills: 0, eggs: 0, eggMax: 2, win: false });
        renderUI();
    }

    function renderUI() {
        // å‡ºæˆ°çƒå“¡
        const active = players.filter(p => !p.name.startsWith("OFF_"));
        document.getElementById('player-buttons').innerHTML = active.map(p => {
            const team = teams.find(t => t.members.includes(p.id));
            const style = team ? `background:${team.color}; color:white; border-color:#fff;` : "";
            return `<div class="p-btn" style="${style}" onclick="handlePlayerClick(${p.id})">${p.name}</div>`;
        }).join('');

        // éšŠä¼å€åŸŸ
        document.getElementById('teams-area').innerHTML = teams.map(t => `
            <div class="team-container" style="border-left-color:${t.color}">
                <button class="team-win-btn ${t.win?'active':''}" style="background:${t.color}" onclick="setWinner(${t.id})">${t.name} è´åº•</button>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>é€²çƒ: <b id="tk-${t.id}">${t.kills}</b></span>
                    <div style="display:flex; gap:5px;">
                        <button onclick="adjKills(${t.id},-1)" style="width:30px">-</button>
                        <button onclick="adjKills(${t.id},1)" style="width:30px">+</button>
                    </div>
                </div>
                <div class="egg-grid" style="margin-top:10px;">
                    <span style="font-size:0.8rem">å½©è›‹:</span>
                    ${Array.from({length: t.eggMax}).map((_, i) => `
                        <button class="egg-btn ${t.eggs > i ? 'active' : ''}" onclick="toggleEgg(${t.id}, ${i+1})">${i+1}</button>
                    `).join('')}
                    <button onclick="addEggSlot(${t.id})" style="background:none; border:1px dashed #444; color:#444; border-radius:50%; width:30px; height:30px;">+</button>
                </div>
            </div>
        `).join('');

        // éŒ¢åŒ…
        document.getElementById('board').innerHTML = players.map(p => {
            const games = history.filter(h => h.blue_members.includes(p.id) || h.red_members.includes(p.id)); // ç°¡åŒ–é‚è¼¯
            const rate = games.length ? Math.round((history.filter(h => h.description.includes(p.name) && h.total_amt > 0).length / games.length)*100) : 0;
            return `
            <div class="score-row">
                <span style="${p.name.startsWith('OFF_')?'color:#444':''}"><small style="color:#555">${rate}%</small> ${p.name.replace("OFF_","")}</span>
                <span style="font-family:monospace; font-weight:bold; color:${p.money>=0?'#4ade80':'#f87171'}" onclick="editMoney(${p.id},'${p.name}',${p.money})">${p.money>0?'+':''}${p.money}</span>
            </div>`;
        }).join('');

        // ç´€éŒ„
        document.getElementById('history-log').innerHTML = history.slice(0, 15).map(h => `
            <div class="history-item">
                <button class="btn-delete" onclick="deleteOrder(${h.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                <small style="color:#555">${new Date(h.created_at).toLocaleTimeString()}</small><br>${h.description}
            </div>
        `).join('');

        // ç®¡ç†æ¸…å–®
        document.getElementById('admin-list').innerHTML = players.map(p => `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>${p.name.replace("OFF_","")}</span>
                <button onclick="toggleStatus(${p.id},'${p.name}')">${p.name.startsWith('OFF_')?'ğŸ’¤ ä¼‘æ¯':'âœ… å‡ºæˆ°'}</button>
            </div>
        `).join('');
    }

    function handlePlayerClick(pid) {
        const currentTeam = teams.find(t => t.members.includes(pid));
        if (currentTeam) {
            currentTeam.members = currentTeam.members.filter(id => id !== pid);
            const nextIdx = teams.indexOf(currentTeam) + 1;
            if (nextIdx < teams.length) teams[nextIdx].members.push(pid);
        } else {
            teams[0].members.push(pid);
        }
        renderUI();
    }

    function adjKills(tid, v) { 
        const t = teams.find(x => x.id === tid);
        t.kills = Math.max(0, t.kills + v);
        renderUI();
    }

    function toggleEgg(tid, num) {
        const t = teams.find(x => x.id === tid);
        t.eggs = (t.eggs === num) ? num - 1 : num;
        renderUI();
    }

    function addEggSlot(tid) {
        teams.find(x => x.id === tid).eggMax += 1;
        renderUI();
    }

    function setWinner(tid) {
        teams.forEach(t => t.win = (t.id === tid));
        renderUI();
    }

    async function calculate() {
        const winner = teams.find(t => t.win);
        if (!winner) return alert("è«‹é¸å‡ºè´åº•çš„éšŠä¼");
        if (teams.some(t => t.members.length > 0 && t.members.length === 0)) return alert("æœ‰éšŠä¼æ²’äºº");

        const base = parseInt(document.getElementById('in-base').value);
        const commonP = parseInt(document.getElementById('in-common').value);
        const eggP = parseInt(document.getElementById('in-egg').value);

        // è©¢å•å€æ•¸é‚è¼¯
        let eggMulti = 1;
        if (teams.some(t => t.eggs >= 3)) {
            const input = prompt("æª¢æ¸¬åˆ°å½©è›‹çƒé”åˆ° 3 é¡†ä»¥ä¸Šï¼Œè«‹è¼¸å…¥å½©è›‹åŠ åˆ†å€æ•¸ (ä¾‹å¦‚é€²3é¡†æƒ³ç®—3å€å°±è¼¸3ï¼ŒåŸæœ¬2é¡†æ˜¯3å€)ï¼š", "3");
            eggMulti = parseInt(input) || 1;
        }

        let calcData = [];
        const activeTeams = teams.filter(t => t.members.length > 0);

        activeTeams.forEach(t => {
            let score = 0;
            if (t.win) score += base;
            else score -= base;

            // ç®—çƒå·® (ç°¡åŒ–ç‚ºè·Ÿæ‰€æœ‰äººæ¯”)
            activeTeams.forEach(ot => {
                if (t.id === ot.id) return;
                score += (t.kills - ot.kills) * commonP;
                
                let tEggScore = t.eggs >= 3 ? (t.eggs * eggP * eggMulti) : (t.eggs === 2 ? eggP * 3 : t.eggs * eggP);
                let otEggScore = ot.eggs >= 3 ? (ot.eggs * eggP * eggMulti) : (ot.eggs === 2 ? eggP * 3 : ot.eggs * eggP);
                score += (tEggScore - otEggScore);
            });

            t.members.forEach(pid => {
                calcData.push({ id: pid, change: Math.floor(score / t.members.length) });
            });
        });

        tempResults = { calcData, desc: `${winner.name}é ˜éŠœçµç®—` };
        document.getElementById('m-title').innerText = "çµç®—é è¦½";
        document.getElementById('m-detail').innerHTML = calcData.map(d => `${players.find(x=>x.id===d.id).name}: ${d.change}`).join('<br>');
        document.getElementById('modal').style.display = 'flex';
    }

    async function confirmUpload() {
        for(let d of tempResults.calcData) {
            const p = players.find(x => x.id === d.id);
            await _supabase.from('players').update({ money: p.money + d.change }).eq('id', p.id);
        }
        await _supabase.from('history').insert([{ 
            total_amt: 0, description: tempResults.desc,
            blue_members: teams[0].members, red_members: teams[1].members, // æ­·å²å…¼å®¹
            detail_json: JSON.stringify(tempResults.calcData)
        }]);
        document.getElementById('modal').style.display = 'none';
        teams.forEach(t => { t.kills = 0; t.eggs = 0; t.win = false; });
        fetchLatest();
    }

    async function deleteOrder(hid) {
        if(prompt("å¯†ç¢¼") !== ADMIN_PW) return;
        const h = history.find(x => x.id === hid);
        const details = JSON.parse(h.detail_json);
        for(let d of details) {
            const p = players.find(x => x.id === d.id);
            if(p) await _supabase.from('players').update({ money: p.money - d.change }).eq('id', p.id);
        }
        await _supabase.from('history').delete().eq('id', hid);
        fetchLatest();
    }

    async function editMoney(pid, name, cur) {
        if(prompt("ç®¡ç†å“¡å¯†ç¢¼") !== ADMIN_PW) return;
        const val = prompt(`ä¿®æ”¹ ${name}`, cur);
        if (val) await _supabase.from('players').update({ money: parseInt(val) }).eq('id', pid);
        fetchLatest();
    }

    function toggleAdmin() { document.getElementById('admin-panel').style.display = (document.getElementById('admin-panel').style.display==='none'?'block':'none'); }
    async function toggleStatus(id, name) {
        const n = name.startsWith("OFF_") ? name.replace("OFF_","") : "OFF_"+name;
        await _supabase.from('players').update({ name: n }).eq('id', id);
        fetchLatest();
    }

    init();
</script>
</body>
</html>
