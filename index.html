<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± ELITE PRO v13.5</title>
    <style>
        :root { --blue: #0084ff; --red: #ff3333; --green: #00ff88; --gold: #ffd700; --bg: #050505; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; margin: 0; padding: 10px; }
        .card { background: #1a1c23; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #333; }
        .p-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        .p-btn { padding: 12px 5px; background: #000; border: 2px solid #333; border-radius: 8px; text-align: center; cursor: pointer; font-weight: bold; }
        .active-t1 { border-color: var(--blue) !important; color: var(--blue); }
        .active-t2 { border-color: var(--red) !important; color: var(--red); }
        .team-box { background: #12141a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #222; }
        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .win-btn { flex: 1; padding: 10px; border: none; border-radius: 5px; background: #333; color: #fff; font-weight: bold; }
        .win-active-1 { background: var(--blue) !important; }
        .win-active-2 { background: var(--red) !important; }
        input[type="number"] { background: #000; color: var(--gold); border: 1px solid #444; width: 45px; text-align: center; border-radius: 4px; padding: 5px; }
        #log { color: #555; font-size: 10px; margin-top: 10px; max-width: 80%; text-align: center; }
    </style>
</head>
<body>

<div id="loading">
    <h2 id="load-status">ğŸ“¡ è³‡æ–™åŒæ­¥ä¸­...</h2>
    <div id="log">ç³»çµ±å•Ÿå‹•ä¸­...</div>
</div>

<div id="app" style="display:none;">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <b>ğŸ‘¥ åœ¨ç·šæˆå“¡</b>
            <button onclick="autoTeam()" style="color:var(--blue); background:none; border:none; font-weight:bold;">éš¨æ©Ÿåˆ†éšŠ</button>
        </div>
        <div id="p-grid" class="p-grid"></div>
    </div>

    <div class="card">
        <b>âš™ï¸ å±€è¨­å®š</b>
        <div style="display:flex; justify-content:space-between; margin:15px 0;">
            <span>åº• <input id="v-base" type="number" value="75"></span>
            <span>çƒ <input id="v-ball" type="number" value="25"></span>
        </div>
        
        <div class="team-box" style="border-left: 4px solid var(--blue);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button id="win-1" class="win-btn" onclick="winT=1;render()">è—éšŠç²å‹</button>
                <span style="margin-left:10px;">é€²çƒ: <b id="k1-val">0</b> <button onclick="adjK(1,1)">+</button> <button onclick="adjK(1,-1)">-</button></span>
            </div>
        </div>

        <div class="team-box" style="border-left: 4px solid var(--red);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button id="win-2" class="win-btn" onclick="winT=2;render()">ç´…éšŠç²å‹</button>
                <span style="margin-left:10px;">é€²çƒ: <b id="k2-val">0</b> <button onclick="adjK(2,1)">+</button> <button onclick="adjK(2,-1)">-</button></span>
            </div>
        </div>

        <button onclick="submitScore()" style="width:100%; padding:18px; background:var(--green); border:none; font-weight:bold; border-radius:10px; font-size:18px; color:#000;">ğŸš€ é€å–®è¨ˆåˆ†</button>
    </div>

    <div class="card">
        <b>ğŸ’ éŒ¢åŒ…æ’å</b>
        <div id="w-list" style="margin-top:10px;"></div>
    </div>
</div>

<script>
    const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1/players';
    const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

    let players = [], t1 = [], t2 = [], k1 = 0, k2 = 0, winT = 0;

    function setLog(msg) { document.getElementById('log').innerText = msg; }

    async function apiFetch() {
        setLog("æ­£åœ¨ç™¼é€è«‹æ±‚...");
        try {
            const res = await fetch(`${API_URL}?select=*`, { headers: HEADERS });
            setLog("ä¼ºæœå™¨å·²å›æ‡‰ (" + res.status + ")");
            
            const rawData = await res.json();
            setLog("è§£æå®Œæˆï¼Œè³‡æ–™ç­†æ•¸: " + rawData.length);

            // ç¢ºä¿ money æ˜¯æ•¸å­—ï¼Œè™•ç† null æƒ…æ³
            players = rawData.map(p => ({
                ...p,
                money: Number(p.money || 0)
            }));

            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            render();
        } catch (e) {
            setLog("âŒ ç™¼ç”ŸéŒ¯èª¤: " + e.message);
            document.getElementById('load-status').innerText = "é€£ç·šå¤±æ•—";
            document.getElementById('load-status').style.color = "red";
        }
    }

    async function apiUpdate(id, newData) {
        try {
            await fetch(`${API_URL}?id=eq.${id}`, {
                method: 'PATCH',
                headers: HEADERS,
                body: JSON.stringify(newData)
            });
        } catch (e) { console.error("Update failed", e); }
    }

    function render() {
        const active = players.filter(p => !p.name.startsWith('OFF_'));
        document.getElementById('p-grid').innerHTML = active.map(p => {
            let cls = t1.includes(p.id) ? 'active-t1' : (t2.includes(p.id) ? 'active-t2' : '');
            return `<div class="p-btn ${cls}" onclick="toggleP(${p.id})">${p.name}</div>`;
        }).join('');

        document.getElementById('win-1').className = `win-btn ${winT===1?'win-active-1':''}`;
        document.getElementById('win-2').className = `win-btn ${winT===2?'win-active-2':''}`;
        document.getElementById('k1-val').innerText = k1;
        document.getElementById('k2-val').innerText = k2;

        document.getElementById('w-list').innerHTML = [...players].sort((a,b)=>b.money-a.money).map(p => `
            <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #222; ${p.name.startsWith('OFF_')?'opacity:0.3':''}">
                <span>${p.name.replace('OFF_','')}</span>
                <b style="color:${p.money>=0?'#0f8':'#f33'}">${p.money}</b>
            </div>`).join('');
    }

    function toggleP(id) {
        if(t1.includes(id)) { t1 = t1.filter(x=>x!==id); t2.push(id); }
        else if(t2.includes(id)) { t2 = t2.filter(x=>x!==id); }
        else { t1.push(id); }
        render();
    }
    function adjK(t, v) { if(t===1) k1=Math.max(0, k1+v); else k2=Math.max(0, k2+v); render(); }

    function autoTeam() {
        const act = players.filter(p => !p.name.startsWith('OFF_'));
        t1 = []; t2 = [];
        act.sort(()=>Math.random()-0.5).forEach((p, i) => i%2===0 ? t1.push(p.id) : t2.push(p.id));
        render();
    }

    async function submitScore() {
        if(!winT || !t1.length || !t2.length) return alert("è«‹åˆ†é…éšŠä¼ä¸¦é¸æ“‡è´å®¶");
        const base = Number(document.getElementById('v-base').value);
        const ball = Number(document.getElementById('v-ball').value);
        
        const winIds = winT === 1 ? t1 : t2;
        const loseIds = winT === 1 ? t2 : t1;
        const score = base + (winT === 1 ? (k1 - k2) : (k2 - k1)) * ball;

        document.getElementById('loading').style.display = 'flex';
        setLog("æ­£åœ¨è¨ˆç®—ä¸¦æ›´æ–°åˆ†æ•¸...");
        
        for (let id of winIds) {
            const p = players.find(x => x.id === id);
            await apiUpdate(id, { money: p.money + score });
        }
        const totalLoss = score * winIds.length;
        const perLoss = Math.floor(totalLoss / loseIds.length);
        for (let id of loseIds) {
            const p = players.find(x => x.id === id);
            await apiUpdate(id, { money: p.money - perLoss });
        }

        t1=[]; t2=[]; k1=0; k2=0; winT=0;
        await apiFetch();
        alert("è¨ˆåˆ†æˆåŠŸï¼");
    }

    window.onload = apiFetch;
</script>
</body>
</html>
