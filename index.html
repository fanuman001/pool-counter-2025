<script>
/* ===============================
   Supabase è¨­å®š
================================ */
const SUPABASE_URL = "https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1";
const SUPABASE_KEY = "sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae";

const HEADERS = {
  apikey: SUPABASE_KEY,
  Authorization: `Bearer ${SUPABASE_KEY}`,
  "Content-Type": "application/json"
};

/* ===============================
   åª½çƒå€ç‡è¨­å®š
================================ */
const MA_MULTIPLIER = {
  1: 1,
  2: 3,
  3: 4,
  4: 6,
  5: 8
};

/* ===============================
   1ï¸âƒ£ ç´”è¨ˆç®—ï¼ˆæ ¸å¿ƒï¼‰
================================ */
/**
 * players: [{id, name, money}]
 * playerTeams: { playerId: teamId }
 * winId: number
 * baseMoney: number
 * extras: [
 *   { type:'ma', teamId, count, price },
 *   { type:'target', fromTeam, toTeam, count, price }
 * ]
 */
function calculateGameResult({
  players,
  playerTeams,
  winId,
  baseMoney,
  extras = [],
  roundId = Date.now()
}) {
  /* --- åˆ†éšŠ --- */
  const teams = {};
  players.forEach(p => {
    const t = playerTeams[p.id];
    if (!teams[t]) teams[t] = [];
    teams[t].push(p.id);
  });

  const teamIds = Object.keys(teams);
  const teamSizes = {};
  teamIds.forEach(t => teamSizes[t] = teams[t].length);

  const maxN = Math.max(...Object.values(teamSizes));
  const teamBase = baseMoney * maxN;

  /* --- åˆå§‹åŒ– --- */
  const teamDelta = {};
  const playerDelta = {};
  teamIds.forEach(t => teamDelta[t] = 0);
  players.forEach(p => playerDelta[p.id] = 0);

  /* --- Base Game --- */
  teamIds.forEach(t => {
    if (Number(t) !== winId) {
      teamDelta[t] -= teamBase;
      teamDelta[winId] += teamBase;
    }
  });

  /* --- Extraï¼šåª½çƒ / å®šå‘çƒ --- */
  extras.forEach(e => {
    const unit = e.price * (MA_MULTIPLIER[e.count] || 1) * maxN;

    if (e.type === "ma") {
      teamIds.forEach(t => {
        if (Number(t) !== e.teamId) {
          teamDelta[t] -= unit;
          teamDelta[e.teamId] += unit;
        }
      });
    }

    if (e.type === "target") {
      teamDelta[e.fromTeam] += unit;
      teamDelta[e.toTeam] -= unit;
    }
  });

  /* --- åˆ†é…åˆ°å€‹äºº --- */
  teamIds.forEach(t => {
    const perPerson = teamDelta[t] / teamSizes[t];
    teams[t].forEach(pid => {
      playerDelta[pid] += perPerson;
    });
  });

  /* --- æœ€çµ‚å››æ¨äº”å…¥ --- */
  Object.keys(playerDelta).forEach(pid => {
    playerDelta[pid] = Math.round(playerDelta[pid]);
  });

  /* --- history ç´”æ–‡å­— --- */
  const teamDesc = teamIds.map(t => {
    const v = Math.round(teamDelta[t]);
    return `éšŠ${t}(${v >= 0 ? "+" : ""}${v})`;
  }).join(" ");

  const description = `å±€#${roundId} ğŸ†éšŠ${winId} ${teamDesc}`;

  return {
    roundId,
    maxN,
    teamBase,
    playerDelta,
    teamDelta,
    description
  };
}

/* ===============================
   2ï¸âƒ£ ä¸€æ¬¡ commit å¯«å…¥ Supabase
================================ */
async function applyResultToSupabase(players, result) {
  /* players.money æ›´æ–° */
  for (const p of players) {
    const delta = result.playerDelta[p.id] || 0;
    if (delta === 0) continue;

    await fetch(`${SUPABASE_URL}/players?id=eq.${p.id}`, {
      method: "PATCH",
      headers: HEADERS,
      body: JSON.stringify({
        money: p.money + delta
      })
    });
  }

  /* history æ–°å¢ */
  await fetch(`${SUPABASE_URL}/history`, {
    method: "POST",
    headers: HEADERS,
    body: JSON.stringify({
      description: result.description
    })
  });
}

/* ===============================
   3ï¸âƒ£ åˆªå–®å›æ»¾ï¼ˆå®Œå…¨é‚„åŸï¼‰
================================ */
function rollbackFromHistory({
  description,
  players,
  playerTeams
}) {
  const regex = /éšŠ(\d+)\(([+-]?\d+)\)/g;
  const teamRollback = {};
  let match;

  while ((match = regex.exec(description)) !== null) {
    teamRollback[match[1]] = -Number(match[2]);
  }

  const playerRollback = {};
  players.forEach(p => playerRollback[p.id] = 0);

  Object.keys(teamRollback).forEach(teamId => {
    const members = players
      .filter(p => playerTeams[p.id] == teamId)
      .map(p => p.id);

    const per = teamRollback[teamId] / members.length;
    members.forEach(pid => {
      playerRollback[pid] += Math.round(per);
    });
  });

  return playerRollback;
}

/* ===============================
   4ï¸âƒ£ å›æ»¾å¯«å› Supabase
================================ */
async function applyRollback(players, rollbackDelta) {
  for (const p of players) {
    const delta = rollbackDelta[p.id] || 0;
    if (delta === 0) continue;

    await fetch(`${SUPABASE_URL}/players?id=eq.${p.id}`, {
      method: "PATCH",
      headers: HEADERS,
      body: JSON.stringify({
        money: p.money + delta
      })
    });
  }
}
</script>
