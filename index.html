<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± ELITE PRO v7.4 - FORCE FIX</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --blue: #0084ff; --red: #ff3333; --green: #00ff88; --gold: #ffd700; --bg: #050505; --card: #12141a; --border: #2d333b; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; margin: 0; padding: 10px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; }
        #check-in-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .check-in-box { width: 90%; max-width: 400px; background: #1a1c23; padding: 25px; border-radius: 20px; text-align: center; border: 1px solid #333; }
        .check-in-list { height: 300px; overflow-y: auto; margin: 15px 0; background: #000; border-radius: 8px; border: 1px solid #222; }
        .p-btn { padding: 10px; background: #1c1f26; border: 2px solid #333; border-radius: 8px; text-align: center; cursor: pointer; color: #666; font-weight: bold; }
        .p-btn.active-p { border-color: #fff; color: #fff; }
        .team-box { border-left: 4px solid var(--t-color); background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        button { cursor: pointer; border: none; border-radius: 5px; padding: 8px 15px; font-weight: bold; }
        .btn-main { background: linear-gradient(135deg, #238636, #2ea043); color: white; width: 100%; padding: 12px; }
    </style>
</head>
<body>

<div id="check-in-screen">
    <div class="check-in-box">
        <h2 style="color:var(--gold); margin-top:0;">ğŸ± é¸æ“‡å‡ºæˆ°æˆå“¡</h2>
        <div id="conn-status" style="font-size:0.7rem; color:#666;">æ­£åœ¨åŒæ­¥è³‡æ–™åº«...</div>
        <div id="check-in-list" class="check-in-list">
            <p style="padding-top:100px; color:#444;">è®€å–ä¸­...</p>
        </div>
        <button class="btn-main" onclick="confirmCheckIn()">âœ… ç¢ºèªæˆå“¡ä¸¦é–‹å±€</button>
        <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
            <button onclick="fetchData()" style="background:#333; color:#fff; font-size:0.7rem;">ğŸ”„ åˆ·æ–°æ¸…å–®</button>
            <button onclick="addNewMember()" style="background:#333; color:#fff; font-size:0.7rem;">â• æ–°å¢æˆå“¡</button>
        </div>
    </div>
</div>

<div class="main-layout" id="main-ui" style="display:none; max-width:1200px; margin:0 auto;">
    <div class="card">
        <div style="display:flex; justify-content:space-between;">
            <b>ä¸Šç·šæˆå“¡</b>
            <button onclick="document.getElementById('check-in-screen').style.display='flex'" style="background:var(--blue); color:#fff; padding:2px 10px;">ä¿®æ”¹åå–®</button>
        </div>
        <div id="p-btns" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap:10px; margin-top:10px;"></div>
    </div>
    
    <div class="card">
        <b>å±€è¨­å®šèˆ‡è¨ˆåˆ†</b>
        <div id="teams-area" style="margin-top:15px;"></div>
        <button class="btn-main" onclick="submitRound()">ğŸš€ å„²å­˜æœ¬å±€ç´€éŒ„</button>
    </div>

    <div class="card">
        <b>éŒ¢åŒ…é¤˜é¡ (ç”±é«˜åˆ°ä½)</b>
        <div id="wallet-list" style="margin-top:10px;"></div>
    </div>
</div>

<script>
    // ç¢ºä¿å­˜å…¥å…¨åŸŸè®Šæ•¸
    const SUPABASE_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const ADMIN_PW = "8888";

    let players = [];
    let teams = [
        { id: 't1', name: 'è—éšŠ', color: '#0084ff', members: [], kills: 0, eggIdx: -1, win: false },
        { id: 't2', name: 'ç´…éšŠ', color: '#ff3333', members: [], kills: 0, eggIdx: -1, win: false }
    ];

    // åˆå§‹åŒ–ï¼šç«‹å³å˜—è©¦æŠ“å–è³‡æ–™
    async function init() {
        console.log("åˆå§‹åŒ–ç³»çµ±...");
        await fetchData();
        
        // ç›£è½å³æ™‚æ›´æ–°
        _db.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, () => {
            console.log("åµæ¸¬åˆ°é ç«¯æ›´æ–°");
            fetchData();
        }).subscribe();
    }

    async function fetchData() {
        document.getElementById('conn-status').innerText = "â³ åŒæ­¥ä¸­...";
        try {
            const { data, error } = await _db.from('players').select('*');
            if (error) throw error;
            
            players = data || [];
            console.log("è³‡æ–™è¼‰å…¥æˆåŠŸ:", players);
            
            document.getElementById('conn-status').innerText = "âœ… åŒæ­¥å®Œæˆ (" + players.length + "äºº)";
            renderCheckIn();
            renderMain();
        } catch (err) {
            console.error("Fetch Error:", err);
            document.getElementById('conn-status').innerText = "âŒ éŒ¯èª¤: " + err.message;
            document.getElementById('check-in-list').innerHTML = `<p style="color:red; padding:20px;">ç„¡æ³•è®€å–è³‡æ–™åº«<br><small>${err.message}</small></p>`;
        }
    }

    function renderCheckIn() {
        const list = document.getElementById('check-in-list');
        if (players.length === 0) {
            list.innerHTML = `<p style="padding-top:100px; color:#666;">è³‡æ–™åº«æ˜¯ç©ºçš„</p>`;
            return;
        }
        list.innerHTML = players.map(p => `
            <div style="padding:15px; border-bottom:1px solid #222; display:flex; align-items:center; text-align:left;">
                <input type="checkbox" style="transform:scale(1.5);" data-id="${p.id}" ${!p.name.startsWith("OFF_")?'checked':''}>
                <span style="margin-left:15px; font-size:1.1rem;">${p.name.replace("OFF_","")}</span>
            </div>
        `).join('');
    }

    async function confirmCheckIn() {
        const checks = document.querySelectorAll('#check-in-list input');
        for (let cb of checks) {
            const p = players.find(x => x.id == cb.dataset.id);
            const isCheck = cb.checked;
            const isOff = p.name.startsWith("OFF_");
            let newName = p.name;
            if (isCheck && isOff) newName = p.name.replace("OFF_", "");
            if (!isCheck && !isOff) newName = "OFF_" + p.name;
            if (newName !== p.name) {
                await _db.from('players').update({ name: newName }).eq('id', p.id);
            }
        }
        document.getElementById('check-in-screen').style.display = 'none';
        document.getElementById('main-ui').style.display = 'block';
        fetchData();
    }

    async function addNewMember() {
        const n = prompt("è¼¸å…¥æ–°æˆå“¡å§“å:");
        if (n) {
            const { error } = await _db.from('players').insert([{ name: "OFF_" + n, money: 0 }]);
            if (error) alert("æ–°å¢å¤±æ•—: " + error.message);
            fetchData();
        }
    }

    function renderMain() {
        const active = players.filter(p => !p.name.startsWith("OFF_"));
        // æ¸²æŸ“çƒå“¡æŒ‰éˆ•
        document.getElementById('p-btns').innerHTML = active.map(p => {
            const t = teams.find(tx => tx.members.includes(p.id));
            return `<div class="p-btn ${t?'active-p':''}" style="${t?'border-color:'+t.color:''}" onclick="handlePClick(${p.id})">${p.name}</div>`;
        }).join('');

        // éŒ¢åŒ…åˆ—è¡¨æ’åº
        const sorted = [...players].sort((a,b) => b.money - a.money);
        document.getElementById('wallet-list').innerHTML = sorted.map(p => `
            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #222;">
                <span>${p.name.replace("OFF_","")}</span>
                <b style="color:${p.money>=0?'#00ff88':'#ff3333'}">${p.money}</b>
            </div>
        `).join('');

        // éšŠä¼è¨ˆåˆ†ç°¡åŒ–æ¸²æŸ“
        document.getElementById('teams-area').innerHTML = teams.map(t => `
            <div class="team-box" style="--t-color:${t.color}">
                <button onclick="setWin('${t.id}')" style="background:${t.win?t.color:'#333'}; color:#fff;">${t.win?'ğŸ† è´å®¶':'æ¨™è¨˜ç²å‹'}</button>
                <span style="margin-left:10px;">é€²çƒ: ${t.kills}</span>
            </div>
        `).join('');
    }

    function handlePClick(id) {
        let ti = teams.findIndex(t=>t.members.includes(id));
        if(ti!==-1) {
            teams[ti].members = teams[ti].members.filter(x=>x!==id);
            if(ti+1 < teams.length) teams[ti+1].members.push(id);
        } else { teams[0].members.push(id); }
        renderMain();
    }
    function setWin(tid) { teams.forEach(t=>t.win=(t.id===tid)); renderMain(); }

    init();
</script>
</body>
</html>
